<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des tickets</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* ... (vos variables CSS) ... */
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #34495e;
            --edit-color: #f39c12;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1, h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .pin-icon {
            cursor: pointer;
            color: var(--primary-color);
            font-size: 1.2em;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        tr:last-child td {
            border-bottom: none;
        }

        button, .file-input-label {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }

        button:hover, .file-input-label:hover {
            background-color: #2980b9;
        }

        .delete-btn {
            background-color: var(--danger-color);
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        .edit-btn {
            background-color: var(--edit-color);
        }

        .edit-btn:hover {
            background-color: #d68910;
        }

        .add-ticket-btn {
            background-color: var(--secondary-color);
        }

        .add-ticket-btn:hover {
            background-color: #27ae60;
        }

        #searchBar {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        #searchBar:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .highlight {
            background-color: #fff176;
            padding: 2px;
            border-radius: 2px;
        }

        #importFile {
            display: none;
        }

        .action-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading::after {
            content: "";
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .action-row {
                flex-direction: column;
                align-items: stretch;
            }

            button, .file-input-label {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
        .logout-button {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background-color: #e74c3c;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logout-button:hover {
        background-color: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .logout-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logout-button i {
        font-size: 16px;
    }

    @media (max-width: 768px) {
        .logout-button {
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            font-size: 12px;
        }
    }
      .database-selector {
        margin-bottom: 20px;
    }

    .database-selector select {
        padding: 10px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 16px;
        background-color: white;
        color: var(--text-color);
        cursor: pointer;
    }

    .database-selector select:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    </style>
</head>
<body>
<button onclick="logout()" class="logout-button">
    <i class="fas fa-sign-out-alt"></i> Déconnexion
</button>
    <div class="container">
        <h1>Gestion des tickets</h1>

        <div class="database-selector">
            <label for="databaseSelect">Choisir la base de données : </label>
            <select id="databaseSelect" onchange="changeDatabase()">
                <option value="TicketsTotal">TicketsTotal</option>
                <option value="TicketsTransit">TicketsTransit</option>
            </select>
        </div>

        <div class="action-row">
            <div>
                <button onclick="exportTickets()">Exporter tous les tickets</button>
                <label for="importFile" class="file-input-label">Importer des tickets</label>
                <input type="file" id="importFile" accept=".json,.csv,.txt" onchange="importTickets(event)">
            </div>
            <button onclick="exportFilteredTickets()">Exporter les tickets filtrés</button>
        </div>
        <input type="text" id="searchBar" placeholder="Rechercher un ticket (mot de passe, prix ou utilisateur)">
        <button onclick="deleteSearchResults()">Supprimer les résultats de recherche</button>
        <div id="ticketCategories"></div>
    </div>

    <div id="loadingIndicator" class="loading" style="display: none;"></div>

    <!-- Modal pour les prix -->
    <div id="priceModal" class="modal">
        <div class="modal-content">
            <h2>Définir le prix</h2>
            <p>Veuillez entrer le prix pour la catégorie <span id="categoryName"></span></p>
            <input type="text" id="priceInput" placeholder="Entrer le prix">
            <div class="modal-buttons">
                <button onclick="confirmPrice()">Confirmer</button>
                <button onclick="cancelImport()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal pour modifier un ticket -->
    <div id="editTicketModal" class="modal">
        <div class="modal-content">
            <h2>Modifier le ticket</h2>
            <input type="text" id="editId" placeholder="ID" disabled>
            <input type="text" id="editCategory" placeholder="Catégorie">
            <input type="text" id="editPassword" placeholder="Mot de passe">
            <input type="text" id="editPrice" placeholder="Prix">
            <input type="text" id="editUser" placeholder="Utilisateur">
            <div class="modal-buttons">
                <button onclick="saveTicketEdit()">Enregistrer</button>
                <button onclick="closeEditModal()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal pour modifier une catégorie -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content">
            <h2>Modifier la catégorie</h2>
            <input type="text" id="editCategoryName" placeholder="Nouveau nom de la catégorie">
            <div class="modal-buttons">
                <button onclick="saveCategoryEdit()">Enregistrer</button>
                <button onclick="closeEditCategoryModal()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter un ticket -->
    <div id="addTicketModal" class="modal">
        <div class="modal-content">
            <h2>Ajouter un nouveau ticket</h2>
            <input type="text" id="newCategory" placeholder="Catégorie">
            <input type="text" id="newPassword" placeholder="Mot de passe">
            <input type="text" id="newPrice" placeholder="Prix">
            <input type="text" id="newUser" placeholder="Utilisateur">
            <div class="modal-buttons">
                <button onclick="saveNewTicket()">Ajouter</button>
                <button onclick="closeAddTicketModal()">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyB6AUBnK_7Vy2ABWI2JMo3ebG_Sljr8XlY",
          authDomain: "cyber-campus-2706f.firebaseapp.com",
          databaseURL: "https://cyber-campus-2706f-default-rtdb.firebaseio.com",
          projectId: "cyber-campus-2706f",
          storageBucket: "cyber-campus-2706f.appspot.com",
          messagingSenderId: "719410601264",
          appId: "1:719410601264:web:44fd2e3757721866303cf5",
          measurementId: "G-CEEFJP5LYZ"
        };
        
        // Initialisation de Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let allTickets = {};
        let tempImportData = null;
        let tempCategory = null;
        let currentEditingTicket = null;
        let currentEditingCategory = null;
        let currentDatabase = 'TicketsTotal';
        
        // Variables pour stocker les informations d'édition
        let editingCategory = '';
        let editingIndex = -1;
        let editingId = '';
        
        // Vérification immédiate avant tout chargement
        (function() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                window.location.replace('login.html');
            }
        })();
        
        // Vérification continue pendant la session
        document.addEventListener('DOMContentLoaded', function() {
            if (!sessionStorage.getItem('isLoggedIn')) {
                window.location.replace('login.html');
            }
        });
        
        // Empêcher le retour à la page après déconnexion
        window.addEventListener('pageshow', function(event) {
            if (event.persisted || !sessionStorage.getItem('isLoggedIn')) {
                window.location.replace('login.html');
            }
        });
        
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
        
        function loadTickets() {
            showLoading();
            const ticketsRef = database.ref(currentDatabase);
            ticketsRef.on('value', (snapshot) => {
                allTickets = snapshot.val() || {};
                displayTickets(allTickets);
                hideLoading();
            }, (error) => {
                console.error("Erreur lors du chargement des tickets:", error);
                hideLoading();
                alert("Erreur lors du chargement des tickets. Veuillez réessayer.");
            });
        }
        // Fonction pour afficher les tickets en fonction de la base de données sélectionnée
        function displayTickets(tickets, searchTerm = '') {
        const categoriesContainer = document.getElementById('ticketCategories');
        categoriesContainer.innerHTML = '';
        
        if (currentDatabase === 'TicketsTotal') {
            displayTicketsTotal(tickets, searchTerm);
        } else if (currentDatabase === 'TicketsTransit') {
            displayTicketsTransit(tickets, searchTerm);
        }
        }
        
        // Fonction pour afficher les tickets de TicketsTotal
        function displayTicketsTotal(tickets, searchTerm = '') {
        const categoriesContainer = document.getElementById('ticketCategories');
        for (let category in tickets) {
            const categoryTickets = tickets[category];
            const categoryHtml = `
                <div class="category-section">
                    <div class="category-header">
                        <div class="category-title">
                            <h2>${category}</h2>
                            <i class="fas fa-thumbtack pin-icon" onclick="editCategory('${category}')"></i>
                        </div>
                        <div>
                            <button class="add-ticket-btn" onclick="showAddTicketModal('${category}')">
                                <i class="fas fa-plus"></i> Ajouter un ticket
                            </button>
                            <label for="importFile_${category}" class="file-input-label">
                                <i class="fas fa-file-import"></i> Importer dans ${category}
                            </label>
                            <input type="file" id="importFile_${category}" 
                                accept=".json,.csv,.txt" 
                                style="display: none;" 
                                onchange="importTicketsToCategory('${category}', event)">
                        </div>
                    </div>
                    <button onclick="deleteAllTicketsInCategory('${category}')">Supprimer tous les tickets de ${category}</button>
                    <table>
                        <thead>
                            <tr>
                                <th>Sélectionner</th>
                                <th>Mot de passe</th>
                                <th>Prix</th>
                                <th>Utilisateur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsBody_${category}">
                            ${generateTicketRowsTotal(category, categoryTickets, searchTerm)}
                        </tbody>
                    </table>
                    <button onclick="deleteSelectedTickets('${category}')">Supprimer les tickets sélectionnés de ${category}</button>
                </div>
            `;
            categoriesContainer.innerHTML += categoryHtml;
        }
        }
        
        // Fonction pour générer les lignes de tableau pour TicketsTotal
        function generateTicketRowsTotal(category, categoryTickets, searchTerm) {
        let rows = '';
        for (let i = 0; i < categoryTickets.motDePasse.length; i++) {
            if (searchTerm && !matchesSearchTotal(categoryTickets, i, searchTerm)) continue;
            rows += `
                <tr>
                    <td><input type="checkbox" name="ticketSelect_${category}" value="${i}"></td>
                    <td>${highlightMatch(categoryTickets.motDePasse[i], searchTerm)}</td>
                    <td>${highlightMatch(categoryTickets.prix[i], searchTerm)}</td>
                    <td>${highlightMatch(categoryTickets.utilisateur[i], searchTerm)}</td>
                    <td>
                        <button class="edit-btn" onclick="editTicketTotal('${category}', ${i})">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="delete-btn" onclick="deleteTicket('${category}', ${i},null)">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                </tr>
            `;
        }
        return rows;
        }
        
        // Fonction pour afficher les tickets de TicketsTransit
        function displayTicketsTransit(tickets, searchTerm = '') {
        const categoriesContainer = document.getElementById('ticketCategories');
        categoriesContainer.innerHTML = '';
        
        const categoryHtml = `
            <div class="category-section">
                <div class="category-header">
                    <div class="category-title">
                        <h2>Tickets en transit</h2>
                    </div>
                    <div>
                        <button class="add-ticket-btn" onclick="showAddTicketModal(null)">
                            <i class="fas fa-plus"></i> Ajouter un ticket
                        </button>
                        <label for="importFile_Transit" class="file-input-label">
                            <i class="fas fa-file-import"></i> Importer dans TicketsTransit
                        </label>
                        <input type="file" id="importFile_Transit" 
                            accept=".json,.csv,.txt" 
                            style="display: none;" 
                            onchange="importTicketsToCategory('TicketsTransit', event)">
                    </div>
                </div>
                <button onclick="deleteAllTicketsInCategory(null)">Supprimer tous les tickets</button>
                <table>
                    <thead>
                        <tr>
                            <th>Sélectionner</th>
                            <th>ID</th>
                            <th>Catégorie</th>
                            <th>Mot de passe</th>
                            <th>Prix</th>
                            <th>Utilisateur</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsBody_Transit">
                        ${generateTicketRowsTransit(tickets, searchTerm)}
                    </tbody>
                </table>
                <button onclick="deleteSelectedTickets(null)">Supprimer les tickets sélectionnés</button>
            </div>
        `;
        
        categoriesContainer.innerHTML = categoryHtml;
        }
        
        // Fonction pour générer les lignes de tableau pour TicketsTransit
        function generateTicketRowsTransit(tickets, searchTerm) {
        let rows = '';
        for (let id in tickets) {
            const ticket = tickets[id];
            if (searchTerm && !matchesSearchTransit(ticket, searchTerm)) continue;
            rows += `
                <tr>
                    <td><input type="checkbox" name="ticketSelect_Transit" value="${id}"></td>
                    <td>${highlightMatch(id, searchTerm)}</td>
                    <td>${highlightMatch(ticket.category, searchTerm)}</td>
                    <td>${highlightMatch(ticket.password, searchTerm)}</td>
                    <td>${highlightMatch(ticket.price, searchTerm)}</td>
                    <td>${highlightMatch(ticket.user, searchTerm)}</td>
                    <td>
                        <button class="edit-btn" onclick="editTicketTransit('${id}')">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="delete-btn" onclick="deleteTicket(null,null, '${id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                </tr>
            `;
        }
        return rows;
        }
        
        function editTicketTransit(id) {
        const ticket = allTickets[id];
        if (ticket) {
            editingId = id;
            document.getElementById('editId').value = id;
            document.getElementById('editCategory').value = ticket.category;
            document.getElementById('editPassword').value = ticket.password;
            document.getElementById('editPrice').value = ticket.price;
            document.getElementById('editUser').value = ticket.user;
            document.getElementById('editTicketModal').style.display = 'block';
        } else {
            alert("Ticket introuvable.");
        }
        }
        
        function saveTicketEdit() {
            const newPassword = document.getElementById('editPassword').value;
            const newPrice = document.getElementById('editPrice').value;
            const newUser = document.getElementById('editUser').value;
            const newCategory = document.getElementById('editCategory').value;
        
            if (!newPassword || !newPrice || !newUser || !newCategory) {
                alert('Tous les champs sont obligatoires');
                return;
            }
        
            showLoading();
        
            if (currentDatabase === 'TicketsTotal') {
                const categoryData = allTickets[editingCategory];
                categoryData.motDePasse[editingIndex] = newPassword;
                categoryData.prix[editingIndex] = newPrice;
                categoryData.utilisateur[editingIndex] = newUser;
        
                const updates = {
                    [`${currentDatabase}/${editingCategory}`]: categoryData
                };
        
                database.ref().update(updates)
                    .then(() => {
                        hideLoading();
                        closeEditModal();
                        alert('Ticket modifié avec succès!');
                    })
                    .catch(error => {
                        console.error("Erreur lors de la modification:", error);
                        hideLoading();
                        alert('Erreur lors de la modification du ticket');
                    });
            } else if (currentDatabase === 'TicketsTransit') {
                const ticketRef = database.ref(`${currentDatabase}/${editingId}`);
                ticketRef.update({
                    category: newCategory,
                    password: newPassword,
                    price: newPrice,
                    user: newUser
                })
                .then(() => {
                    hideLoading();
                    closeEditModal();
                    alert('Ticket modifié avec succès!');
                })
                .catch(error => {
                    console.error("Erreur lors de la modification:", error);
                    hideLoading();
                    alert('Erreur lors de la modification du ticket');
                });
            }
        }
        
                function editTicketTotal(category, index) {
                    editingCategory = category;
                    editingIndex = index;
                    const ticket = allTickets[category];
                    
                    document.getElementById('editId').value = '';
                    document.getElementById('editCategory').value = category;
                    document.getElementById('editPassword').value = ticket.motDePasse[index];
                    document.getElementById('editPrice').value = ticket.prix[index];
                    document.getElementById('editUser').value = ticket.utilisateur[index];
                    
                    document.getElementById('editTicketModal').style.display = 'block';
                }
        
                
        
                function importTicketsToCategory(category, event) {
                    const file = event.target.files[0];
                    if (!file) return;
        
                    showLoading();
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const fileExtension = file.name.split('.').pop().toLowerCase();
                            if (fileExtension === 'json') {
                                handleJsonImportToCategory(e.target.result, category);
                            } else if (fileExtension === 'csv') {
                                handleCsvImportToCategory(e.target.result, category);
                            } else if (fileExtension === 'txt') {
                                handleTxtImportToCategory(e.target.result, category);
                            } else {
                                throw new Error('Format de fichier non supporté');
                            }
                        } catch (error) {
                            console.error('Erreur d\'importation:', error);
                            hideLoading();
                            alert('Erreur lors de l\'importation. Veuillez vérifier le format du fichier.');
                        }
                    };
                    reader.readAsText(file);
                }
        
                function handleJsonImportToCategory(jsonContent, category) {
                    const importedData = JSON.parse(jsonContent);
        
                    // Structure pour les tickets en transit
                    if (currentDatabase === 'TicketsTransit') {
                        for (let id in importedData) {
                            if (!importedData[id].category || !importedData[id].password || !importedData[id].price || !importedData[id].user) {
                                hideLoading();
                                alert('Format JSON invalide pour TicketsTransit');
                                return;
                            }
                        }
                    } else { // Structure pour TicketsTotal
                        if (category === 'TicketsTransit') {
                            for (let id in importedData) {
                                if (!importedData[id].category || !importedData[id].password || !importedData[id].price || !importedData[id].user) {
                                    hideLoading();
                                    alert('Format JSON invalide pour TicketsTransit');
                                    return;
                                }
                            }
                        } else if (!importedData[category] || !importedData[category].motDePasse || !importedData[category].prix || !importedData[category].utilisateur) {
                            hideLoading();
                            alert('Format JSON invalide pour TicketsTotal');
                            return;
                        }
                    }
        
                    mergeTicketsToCategory(category, importedData);
                }
        
                function handleCsvImportToCategory(csvContent, category) {
                    const lines = csvContent.split('\n');
                    let tickets = {};
                
                    if (currentDatabase === 'TicketsTransit') {
                        let tempTickets = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            const values = lines[i].split(',');
                            const id = values[0] ? values[0].trim() : `id-${Date.now()}-${i}`;
                            tempTickets.push({
                                id: id,
                                category: values[1] ? values[1].trim() : 'N/A',
                                password: values[2] ? values[2].trim() : '',
                                price: values[3] ? values[3].trim() : '',
                                user: values[4] ? values[4].trim() : ''
                            });
                        }
                        tempImportData = { tickets: tempTickets };
                        tempCategory = "TicketsTransit";
                        showPriceModal("TicketsTransit Import");
                    } else {
                        // Si l'importation est pour TicketsTotal
                        const tickets = {
                            motDePasse: [],
                            prix: [],
                            utilisateur: []
                        };
                
                        // Skip header line
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const values = lines[i].split(',');
                            tickets.utilisateur.push(values[0].trim());
                            tickets.motDePasse.push(values[1].trim());
                            if (values[3]) { // Si le prix est inclus dans le CSV
                                tickets.prix.push(values[3].trim());
                            }
                        }
                
                        if (!tickets.prix.length) {
                            tempImportData = { [category]: tickets };
                            tempCategory = category;
                            showPriceModal(category);
                        } else {
                            mergeTicketsToCategory(category, tickets);
                        }
                    }
                }
        
                function handleTxtImportToCategory(txtContent, category) {
                    const lines = txtContent.split('\n');
                    let tickets = {};
        
                    if (currentDatabase === 'TicketsTransit') {
                        const regex = /add name="([^"]+)" password="([^"]+)" profile="([^"]+)"/;
                        let tempTickets = {
                            motDePasse: [],
                            prix: [],
                            utilisateur: []
                        };
        
                        for (let line of lines) {
                            line = line.trim();
                            if (!line || line === '/ip hotspot user') continue;
                            const match = line.match(regex);
                            if (match) {
                                const [_, name, password, profile] = match;
                                tempTickets.utilisateur.push(name);
                                tempTickets.motDePasse.push(password);
                                tempTickets.prix.push(profile);
                            }
                        }
                        for(let i = 0; i < tempTickets.utilisateur.length; i++) {
                            const id = `id-${Date.now()}-${i}`;
                            tickets[id] = {
                                id,
                                category: "Cadeau",
                                password: tempTickets.motDePasse[i],
                                price: '1',
                                user: tempTickets.utilisateur[i]
                            }
                        }
        
                        if (Object.keys(tickets).length > 0) {
                            mergeTicketsToCategory(null, tickets);
                        } else {
                            hideLoading();
                            alert('Aucun ticket valide trouvé dans le fichier pour TicketsTransit');
                        }
                    } else { // Si l'importation est pour TicketsTotal
                        const regex = /add name="([^"]+)" password="([^"]+)" profile="([^"]+)"/;
                        for (let line of lines) {
                            line = line.trim();
                            if (!line || line === '/ip hotspot user') continue;
        
                            const match = line.match(regex);
                            if (match) {
                                const [_, name, password, profile] = match;
                                if (!tickets[profile]) {
                                    tickets[profile] = {
                                        motDePasse: [],
                                        prix: [],
                                        utilisateur: []
                                    };
                                }
        
                                tickets[profile].utilisateur.push(name);
                                tickets[profile].motDePasse.push(password);
                            }
                        }
        
                        if (Object.keys(tickets).length === 0) {
                            hideLoading();
                            alert('Aucun ticket valide n\'a été trouvé dans le fichier');
                            return;
                        }
        
                        tempImportData = tickets;
                        const firstCategory = Object.keys(tickets)[0];
                        showPriceModal(firstCategory);
                    }
                }
        
                function mergeTicketsToCategory(category, newTickets) {
                    let updates = {};
                
                    if (currentDatabase === 'TicketsTransit') {
                        // Mettre à jour directement newTickets avec les IDs générés
                        for (let id in newTickets) {
                            updates[`${currentDatabase}/${id}`] = newTickets[id];
                        }
                    } else {
                        if (!allTickets[category]) {
                            allTickets[category] = {
                                motDePasse: [],
                                prix: [],
                                utilisateur: []
                            };
                        }
                        const currentTickets = allTickets[category];
                        const mergedTickets = {
                            motDePasse: [...currentTickets.motDePasse, ...newTickets.motDePasse],
                            prix: [...currentTickets.prix, ...newTickets.prix],
                            utilisateur: [...currentTickets.utilisateur, ...newTickets.utilisateur]
                        };
                        updates[`${currentDatabase}/${category}`] = mergedTickets;
                    }
                
                    database.ref().update(updates)
                        .then(() => {
                            hideLoading();
                            alert(`Importation réussie dans ${category || 'TicketsTransit'}!`);
                        })
                        .catch((error) => {
                            console.error("Erreur lors de l'importation:", error);
                            hideLoading();
                            alert("Erreur lors de l'importation. Veuillez réessayer.");
                        });
                }
        
                function editCategory(category) {
                    currentEditingCategory = category;
                    document.getElementById('editCategoryName').value = category;
                    document.getElementById('editCategoryModal').style.display = 'block';
                }
        
                function saveCategoryEdit() {
                    const newCategoryName = document.getElementById('editCategoryName').value.trim();
                    
                    if (!newCategoryName) {
                        alert('Le nom de la catégorie ne peut pas être vide');
                        return;
                    }
        
                    if (newCategoryName === currentEditingCategory) {
                        closeEditCategoryModal();
                        return;
                    }
        
                    showLoading();
                    const categoryData = allTickets[currentEditingCategory];
                    
                    const updates = {
                        [`${currentDatabase}/${currentEditingCategory}`]: null,
                        [`${currentDatabase}/${newCategoryName}`]: categoryData
                    };
        
                    database.ref().update(updates)
                        .then(() => {
                            hideLoading();
                            closeEditCategoryModal();
                            alert('Catégorie modifiée avec succès!');
                        })
                        .catch(error => {
                            console.error("Erreur lors de la modification de la catégorie:", error);
                            hideLoading();
                            alert('Erreur lors de la modification de la catégorie');
                        });
                }
        
                function showAddTicketModal(category) {
                    currentEditingCategory = category;
                    document.getElementById('newPassword').value = '';
                    document.getElementById('newPrice').value = '';
                    document.getElementById('newUser').value = '';
                    document.getElementById('newCategory').value = '';
                    document.getElementById('addTicketModal').style.display = 'block';
                }
        
                function saveNewTicket() {
                    showLoading();
                    if (currentDatabase === 'TicketsTransit') {
                        const id = `id-${Date.now()}`; // Générer un ID unique pour TicketsTransit
                        const newTicket = {
                            id: id, // Ajout de l'ID
                            category: document.getElementById('newCategory').value.trim(),
                            password: document.getElementById('newPassword').value.trim(),
                            price: document.getElementById('newPrice').value.trim(),
                            user: document.getElementById('newUser').value.trim()
                        };
                        
                        database.ref(`${currentDatabase}/${id}`).set(newTicket)
                            .then(() => {
                                hideLoading();
                                closeAddTicketModal();
                                alert('Ticket ajouté avec succès dans TicketsTransit!');
                            })
                            .catch(error => {
                                console.error("Erreur lors de l'ajout du ticket:", error);
                                hideLoading();
                                alert('Erreur lors de l\'ajout du ticket');
                            });
                    } else {
                        const category = currentEditingCategory;
                        const newTicket = {
                            password: document.getElementById('newPassword').value.trim(),
                            price: document.getElementById('newPrice').value.trim(),
                            user: document.getElementById('newUser').value.trim()
                        };
        
                        const categoryData = allTickets[category] || { motDePasse: [], prix: [], utilisateur: [] };
                        categoryData.motDePasse.push(newTicket.password);
                        categoryData.prix.push(newTicket.price);
                        categoryData.utilisateur.push(newTicket.user);
        
                        database.ref(`${currentDatabase}/${category}`).set(categoryData)
                            .then(() => {
                                hideLoading();
                                closeAddTicketModal();
                                alert('Ticket ajouté avec succès dans TicketsTotal!');
                            })
                            .catch(error => {
                                console.error("Erreur lors de l'ajout du ticket:", error);
                                hideLoading();
                                alert('Erreur lors de l\'ajout du ticket');
                            });
                    }
                }
        
                function closeEditModal() {
                    document.getElementById('editTicketModal').style.display = 'none';
                    editingCategory = '';
                    editingIndex = -1;
                }
        
                function closeEditCategoryModal() {
                    document.getElementById('editCategoryModal').style.display = 'none';
                    currentEditingCategory = null;
                }
        
                function closeAddTicketModal() {
                    document.getElementById('addTicketModal').style.display = 'none';
                    currentEditingCategory = null;
                }
        
        function matchesSearchTotal(categoryTickets, index, searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase();
            return categoryTickets.motDePasse[index].toLowerCase().includes(lowerSearchTerm) ||
                   categoryTickets.prix[index].toLowerCase().includes(lowerSearchTerm) ||
                   categoryTickets.utilisateur[index].toLowerCase().includes(lowerSearchTerm);
        }
        
        function matchesSearchTransit(ticket, searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase();
            return (ticket.id && ticket.id.toLowerCase().includes(lowerSearchTerm)) ||
                   (ticket.category && ticket.category.toLowerCase().includes(lowerSearchTerm)) ||
                   (ticket.password && ticket.password.toLowerCase().includes(lowerSearchTerm)) ||
                   (ticket.price && ticket.price.toLowerCase().includes(lowerSearchTerm)) ||
                   (ticket.user && ticket.user.toLowerCase().includes(lowerSearchTerm));
        }
        
        // Modifiez la fonction matchesSearch pour utiliser la fonction appropriée en fonction de la base de données
        function matchesSearch(data, index, searchTerm) {
            if (currentDatabase === 'TicketsTotal') {
                return matchesSearchTotal(data, index, searchTerm);
            } else if (currentDatabase === 'TicketsTransit') {
                return matchesSearchTransit(data, searchTerm);
            }
            return false;
        }
        
                function highlightMatch(text, searchTerm) {
                    if (!searchTerm) return text;
                    const regex = new RegExp(searchTerm, 'gi');
                    return text.replace(regex, match => `<span class="highlight">${match}</span>`);
                }
        
                function deleteTicket(category, index, id) {
                    if (confirm('Êtes-vous sûr de vouloir supprimer ce ticket ?')) {
                        showLoading();
                        if (currentDatabase === 'TicketsTransit') {
                            database.ref(`${currentDatabase}/${id}`).remove()
                                .then(() => {
                                    hideLoading();
                                    alert('Ticket supprimé avec succès!');
                                })
                                .catch(error => {
                                    console.error("Erreur lors de la suppression:", error);
                                    hideLoading();
                                    alert('Erreur lors de la suppression du ticket');
                                });
                        } else {
                            const categoryData = allTickets[category];
                            categoryData.motDePasse.splice(index, 1);
                            categoryData.prix.splice(index, 1);
                            categoryData.utilisateur.splice(index, 1);
        
                            database.ref(`${currentDatabase}/${category}`).set(categoryData)
                            .then(() => {
                                hideLoading();
                                alert('Ticket supprimé avec succès!');
                            })
                            .catch(error => {
                                console.error("Erreur lors de la suppression:", error);
                                hideLoading();
                                alert('Erreur lors de la suppression du ticket');
                            });
                        }
                    }
                }
        
                function deleteSelectedTickets(category) {
                    const selectedTickets = document.querySelectorAll(`input[name^="ticketSelect_${category || 'Transit'}"]:checked`);
                    if (selectedTickets.length === 0) {
                        alert('Veuillez sélectionner au moins un ticket à supprimer');
                        return;
                    }
        
                    if (confirm('Êtes-vous sûr de vouloir supprimer les tickets sélectionnés ?')) {
                        showLoading();
                        const updates = {};
        
                        if (currentDatabase === 'TicketsTransit') {
                            selectedTickets.forEach(checkbox => {
                                const ticketId = checkbox.value;
                                updates[`${currentDatabase}/${ticketId}`] = null;
                            });
                        } else {
                            const categoryData = allTickets[category];
                            const indices = Array.from(selectedTickets)
                                .map(checkbox => parseInt(checkbox.value))
                                .sort((a, b) => b - a);
        
                            indices.forEach(index => {
                                categoryData.motDePasse.splice(index, 1);
                                categoryData.prix.splice(index, 1);
                                categoryData.utilisateur.splice(index, 1);
                            });
        
                            updates[`${currentDatabase}/${category}`] = categoryData;
                        }
        
                        database.ref().update(updates)
                            .then(() => {
                                hideLoading();
                                alert('Tickets sélectionnés supprimés avec succès!');
                            })
                            .catch(error => {
                                console.error("Erreur lors de la suppression:", error);
                                hideLoading();
                                alert('Erreur lors de la suppression des tickets');
                            });
                    }
                }
        
                function deleteAllTicketsInCategory(category) {
                    if (confirm(`Êtes-vous sûr de vouloir supprimer TOUS les tickets de ${category || 'TicketsTransit'} ?`)) {
                        showLoading();
                        if (currentDatabase === 'TicketsTransit') {
                            database.ref(currentDatabase).set({})
                                .then(() => {
                                    hideLoading();
                                    alert('Tous les tickets ont été supprimés avec succès!');
                                })
                                .catch(error => {
                                    console.error("Erreur lors de la suppression:", error);
                                    hideLoading();
                                    alert('Erreur lors de la suppression des tickets');
                                });
                        } else {
                            database.ref(`${currentDatabase}/${category}`).set({
                                motDePasse: [],
                                prix: [],
                                utilisateur: []
                            })
                            .then(() => {
                                hideLoading();
                                alert('Tous les tickets de la catégorie ont été supprimés avec succès!');
                            })
                            .catch(error => {
                                console.error("Erreur lors de la suppression:", error);
                                hideLoading();
                                alert('Erreur lors de la suppression des tickets');
                            });
                        }
                    }
                }
        
                function exportTickets() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allTickets, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `tickets_export_${currentDatabase}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }
        
                function exportFilteredTickets() {
                    const searchTerm = document.getElementById('searchBar').value.trim();
                    const filteredTickets = {};
        
                    if (currentDatabase === 'TicketsTransit') {
                        for (let id in allTickets) {
                            if (!searchTerm || matchesSearchTransit(allTickets[id], searchTerm)) {
                                filteredTickets[id] = allTickets[id];
                            }
                        }
                    } else {
                        for (let category in allTickets) {
                            const categoryTickets = allTickets[category];
                            filteredTickets[category] = {
                                motDePasse: [],
                                prix: [],
                                utilisateur: []
                            };
        
                            for (let i = 0; i < categoryTickets.motDePasse.length; i++) {
                                if (!searchTerm || matchesSearchTotal(categoryTickets, i, searchTerm)) {
                                    filteredTickets[category].motDePasse.push(categoryTickets.motDePasse[i]);
                                    filteredTickets[category].prix.push(categoryTickets.prix[i]);
                                    filteredTickets[category].utilisateur.push(categoryTickets.utilisateur[i]);
                                }
                            }
                        }
                    }
        
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(filteredTickets, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `filtered_tickets_export_${currentDatabase}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }
        
                function handleJsonImport(jsonContent) {
                    const importedData = JSON.parse(jsonContent);
                    if (confirm('Êtes-vous sûr de vouloir importer ces tickets ? Les nouveaux tickets seront ajoutés aux tickets existants.')) {
                        const updates = {};
                        for (let category in importedData) {
                            if (allTickets[category]) {
                                // Fusion des tickets existants avec les nouveaux
                                updates[`${currentDatabase}/${category}`] = {
                                    motDePasse: [...allTickets[category].motDePasse, ...importedData[category].motDePasse],
                                    prix: [...allTickets[category].prix, ...importedData[category].prix],
                                    utilisateur: [...allTickets[category].utilisateur, ...importedData[category].utilisateur]
                                };
                            } else {
                                // Nouvelle catégorie
                                updates[`${currentDatabase}/${category}`] = importedData[category];
                            }
                        }
                        database.ref().update(updates)
                            .then(() => {
                                hideLoading();
                                alert('Importation réussie !');
                            })
                            .catch((error) => {
                                console.error("Erreur lors de l'importation:", error);
                                hideLoading();
                                alert("Erreur lors de l'importation. Veuillez réessayer.");
                            });
                    } else {
                        hideLoading();
                    }
                }
        
               function handleCsvImport(csvContent) {
                    const lines = csvContent.split('\n');
                    let tickets = {};
        
                    if (currentDatabase === 'TicketsTransit') {
                        let tempTickets = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            const values = lines[i].split(',');
                            const id = values[0] ? values[0].trim() : `id-${Date.now()}-${i}`;
                            tempTickets.push({
                                id: id,
                                category: values[1] ? values[1].trim() : 'N/A',
                                password: values[2] ? values[2].trim() : '',
                                price: values[3] ? values[3].trim() : '',
                                user: values[4] ? values[4].trim() : ''
                            });
                        }
                        tempImportData = { tickets: tempTickets };
                        tempCategory = "TicketsTransit";
                        showPriceModal("TicketsTransit Import");
                    } else {
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            const values = lines[i].split(',');
                            const category = values[2].trim(); // Profile column
        
                            if (!tickets[category]) {
                                tickets[category] = {
                                    motDePasse: [],
                                    prix: [],
                                    utilisateur: []
                                };
                            }
        
                            tickets[category].utilisateur.push(values[0].trim());
                            tickets[category].motDePasse.push(values[1].trim());
                        }
        
                        tempImportData = tickets;
                        const firstCategory = Object.keys(tickets)[0];
                        showPriceModal(firstCategory);
                    }
                }
        
                function handleTxtImport(txtContent) {
                    const lines = txtContent.split('\n');
                    let tickets = {};
        
                    if (currentDatabase === 'TicketsTransit') {
                        const regex = /add name="([^"]+)" password="([^"]+)" profile="([^"]+)"/;
                        let tempTickets = [];
        
                        for (let line of lines) {
                            line = line.trim();
                            if (!line || line === '/ip hotspot user') continue;
                            const match = line.match(regex);
                            if (match) {
                                const [_, name, password, profile] = match;
                                tempTickets.push({
                                    category: profile,
                                    password: password,
                                    user: name
                                });
                            }
                        }
                        tempImportData = { tickets: tempTickets };
                        tempCategory = "TicketsTransit";
                        showPriceModal("TicketsTransit Import");
                    } else {
                        const regex = /add name="([^"]+)" password="([^"]+)" profile="([^"]+)"/;
                        for (let line of lines) {
                            line = line.trim();
                            if (!line || line === '/ip hotspot user') continue;
        
                            const match = line.match(regex);
                            if (match) {
                                const [_, name, password, profile] = match;
                                if (!tickets[profile]) {
                                    tickets[profile] = {
                                        motDePasse: [],
                                        prix: [],
                                        utilisateur: []
                                    };
                                }
        
                                tickets[profile].utilisateur.push(name);
                                tickets[profile].motDePasse.push(password);
                            }
                        }
        
                        if (Object.keys(tickets).length === 0) {
                            hideLoading();
                            alert('Aucun ticket valide n\'a été trouvé dans le fichier');
                            return;
                        }
        
                        tempImportData = tickets;
                        const firstCategory = Object.keys(tickets)[0];
                        showPriceModal(firstCategory);
                    }
                }
        
                function showPriceModal(category) {
                    tempCategory = category;
                    document.getElementById('categoryName').textContent = category;
                    document.getElementById('priceModal').style.display = 'block';
                    document.getElementById('priceInput').value = '';
                }
        
                function confirmPrice() {
                    const price = document.getElementById('priceInput').value.trim();
                    if (!price) {
                        alert('Veuillez entrer un prix');
                        return;
                    }
                
                    if (currentDatabase === 'TicketsTransit') {
                        tempImportData.tickets.forEach(ticket => {
                            ticket.price = price;
                        });
                        finishImportTransit();
                    } else {
                        tempImportData[tempCategory].prix = Array(tempImportData[tempCategory].motDePasse.length).fill(price);
                        const categories = Object.keys(tempImportData);
                        const currentIndex = categories.indexOf(tempCategory);
                
                        if (currentIndex < categories.length - 1) {
                            document.getElementById('priceInput').value = '';
                            showPriceModal(categories[currentIndex + 1]);
                        } else {
                            finishImport();
                        }
                    }
                }
        
                function cancelImport() {
                    document.getElementById('priceModal').style.display = 'none';
                    if (currentDatabase === 'TicketsTransit') {
                        tempImportData = null;
                    }
                    document.getElementById('importFile').value = '';
                    tempCategory = null;
                    hideLoading();
                }
        
                function finishImportTransit() {
                    if (confirm('Êtes-vous sûr de vouloir importer ces tickets ?')) {
                        const updates = {};
                        tempImportData.tickets.forEach((ticket, index) => {
                            // Utiliser l'ID existant ou en générer un nouveau si nécessaire
                            const id = ticket.id || `id-${Date.now()}-${index}`;
                            updates[`${currentDatabase}/${id}`] = {
                                id: id, // S'assurer que l'ID est inclus
                                category: ticket.category,
                                password: ticket.password,
                                price: ticket.price,
                                user: ticket.user
                            };
                        });
                
                        database.ref().update(updates)
                            .then(() => {
                                document.getElementById('priceModal').style.display = 'none';
                                document.getElementById('importFile').value = '';
                                tempImportData = null;
                                tempCategory = null;
                                hideLoading();
                                alert('Importation réussie !');
                            })
                            .catch((error) => {
                                console.error("Erreur lors de l'importation:", error);
                                hideLoading();
                                alert("Erreur lors de l'importation. Veuillez réessayer.");
                            });
                    } else {
                        cancelImport();
                    }
                }
        
                function finishImport() {
                    if (confirm('Êtes-vous sûr de vouloir importer ces tickets ? Les nouveaux tickets seront ajoutés aux tickets existants.')) {
                        const updates = {};
                        for (let category in tempImportData) {
                            if (allTickets[category]) {
                                // Fusion des tickets existants avec les nouveaux
                                updates[`${currentDatabase}/${category}`] = {
                                    motDePasse: [...allTickets[category].motDePasse, ...tempImportData[category].motDePasse],
                                    prix: [...allTickets[category].prix, ...tempImportData[category].prix],
                                    utilisateur: [...allTickets[category].utilisateur, ...tempImportData[category].utilisateur]
                                };
                            } else {
                                // Nouvelle catégorie
                                updates[`${currentDatabase}/${category}`] = tempImportData[category];
                            }
                        }
                        
                        database.ref().update(updates)
                            .then(() => {
                                document.getElementById('priceModal').style.display = 'none';
                                document.getElementById('importFile').value = '';
                                tempImportData = null;
                                tempCategory = null;
                                hideLoading();
                                alert('Importation réussie !');
                            })
                            .catch((error) => {
                                console.error("Erreur lors de l'importation:", error);
                                hideLoading();
                                alert("Erreur lors de l'importation. Veuillez réessayer.");
                            });
                    } else {
                        cancelImport();
                    }
                }
        
                function importTickets(event) {
                    const file = event.target.files[0];
                    if (!file) return;
        
                    showLoading();
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const fileExtension = file.name.split('.').pop().toLowerCase();
                            if (fileExtension === 'json') {
                                handleJsonImport(e.target.result);
                            } else if (fileExtension === 'csv') {
                                handleCsvImport(e.target.result);
                            } else if (fileExtension === 'txt') {
                                handleTxtImport(e.target.result);
                            } else {
                                throw new Error('Format de fichier non supporté');
                            }
                        } catch (error) {
                            console.error('Erreur d\'importation:', error);
                            hideLoading();
                            alert('Erreur lors de l\'importation. Veuillez vérifier le format du fichier.');
                        }
                    };
                    reader.readAsText(file);
                }
        
                function deleteSearchResults() {
                    const searchTerm = document.getElementById('searchBar').value.trim();
                    if (!searchTerm) {
                        alert('Veuillez entrer un terme de recherche avant de supprimer.');
                        return;
                    }
        
                    if (confirm('Êtes-vous sûr de vouloir supprimer tous les tickets correspondant à votre recherche ?')) {
                        showLoading();
                        const updates = {};
        
                        if (currentDatabase === 'TicketsTransit') {
                            for (let id in allTickets) {
                                if (matchesSearchTransit(allTickets[id], searchTerm)) {
                                    updates[`${currentDatabase}/${id}`] = null;
                                }
                            }
                        } else {
                            for (let category in allTickets) {
                                const categoryTickets = allTickets[category];
                                const newCategoryData = {
                                    motDePasse: [],
                                    prix: [],
                                    utilisateur: []
                                };
        
                                for (let i = 0; i < categoryTickets.motDePasse.length; i++) {
                                    if (!matchesSearchTotal(categoryTickets, i, searchTerm)) {
                                        newCategoryData.motDePasse.push(categoryTickets.motDePasse[i]);
                                        newCategoryData.prix.push(categoryTickets.prix[i]);
                                        newCategoryData.utilisateur.push(categoryTickets.utilisateur[i]);
                                    }
                                }
                                updates[`${currentDatabase}/${category}`] = newCategoryData;
                            }
                        }
        
                        database.ref().update(updates)
                            .then(() => {
                                hideLoading();
                                alert('Les tickets correspondant à la recherche ont été supprimés.');
                            })
                            .catch((error) => {
                                console.error("Erreur lors de la suppression des résultats de recherche:", error);
                                hideLoading();
                                alert("Erreur lors de la suppression des résultats de recherche. Veuillez réessayer.");
                            });
                    }
                }
        
                function searchTickets() {
                    const searchTerm = document.getElementById('searchBar').value.trim();
                    displayTickets(allTickets, searchTerm);
                }
        
                // Ajoutez ce code au début de votre script existant, juste après la déclaration des variables
        
                function checkAuth() {
                    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
                    
                    if (!isLoggedIn) {
                        window.location.replace('login.html');
                        return false;
                    }
                    
                    return true;
                }
        
                function changeDatabase() {
                    currentDatabase = document.getElementById('databaseSelect').value;
                    loadTickets();
                }
        
                // Modifiez la fonction window.onload
                window.onload = () => {
                    if (checkAuth()) {
                        loadTickets();
                    }
                };
        
                // Fonction de déconnexion améliorée
                function logout() {
                    sessionStorage.clear(); // Nettoie toutes les données de session
                    window.location.replace('login.html');
                }
        
                // Écouteur d'événement pour la recherche
                document.getElementById('searchBar').addEventListener('input', searchTickets);
        
                // Chargement initial des tickets
                window.onload = () => {
                    if (checkAuth()) {
                        loadTickets();
                    }
                };
            </script>
    
</body>
</html>