<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des tickets totaux</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #34495e;
            --edit-color: #f39c12;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1, h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .pin-icon {
            cursor: pointer;
            color: var(--primary-color);
            font-size: 1.2em;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        tr:last-child td {
            border-bottom: none;
        }

        button, .file-input-label {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }

        button:hover, .file-input-label:hover {
            background-color: #2980b9;
        }

        .delete-btn {
            background-color: var(--danger-color);
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        .edit-btn {
            background-color: var(--edit-color);
        }

        .edit-btn:hover {
            background-color: #d68910;
        }

        .add-ticket-btn {
            background-color: var(--secondary-color);
        }

        .add-ticket-btn:hover {
            background-color: #27ae60;
        }

        #searchBar {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        #searchBar:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .highlight {
            background-color: #fff176;
            padding: 2px;
            border-radius: 2px;
        }

        #importFile {
            display: none;
        }

        .action-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading::after {
            content: "";
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .action-row {
                flex-direction: column;
                align-items: stretch;
            }

            button, .file-input-label {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
        .logout-button {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background-color: #e74c3c;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logout-button:hover {
        background-color: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .logout-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logout-button i {
        font-size: 16px;
    }

    @media (max-width: 768px) {
        .logout-button {
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            font-size: 12px;
        }
    }
    </style>
</head>
<body>
<!-- Remplacez le bouton de déconnexion existant par celui-ci -->
<button onclick="logout()" class="logout-button">
    <i class="fas fa-sign-out-alt"></i> Déconnexion
</button>
    <div class="container">
        <h1>Gestion des tickets totaux</h1>
        <div class="action-row">
            <div>
                <button onclick="exportTickets()">Exporter tous les tickets</button>
                <label for="importFile" class="file-input-label">Importer des tickets</label>
                <input type="file" id="importFile" accept=".json,.csv,.txt" onchange="importTickets(event)">
            </div>
            <button onclick="exportFilteredTickets()">Exporter les tickets filtrés</button>
        </div>
        <input type="text" id="searchBar" placeholder="Rechercher un ticket (mot de passe, prix ou utilisateur)">
        <button onclick="deleteSearchResults()">Supprimer les résultats de recherche</button>
        <div id="ticketCategories"></div>
    </div>

    <div id="loadingIndicator" class="loading" style="display: none;"></div>

    <!-- Modal pour les prix -->
    <div id="priceModal" class="modal">
        <div class="modal-content">
            <h2>Définir le prix</h2>
            <p>Veuillez entrer le prix pour la catégorie <span id="categoryName"></span></p>
            <input type="text" id="priceInput" placeholder="Entrer le prix">
            <div class="modal-buttons">
                <button onclick="confirmPrice()">Confirmer</button>
                <button onclick="cancelImport()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal pour modifier un ticket -->
    <div id="editTicketModal" class="modal">
        <div class="modal-content">
            <h2>Modifier le ticket</h2>
            <input type="text" id="editPassword" placeholder="Mot de passe">
            <input type="text" id="editPrice" placeholder="Prix">
            <input type="text" id="editUser" placeholder="Utilisateur">
            <div class="modal-buttons">
                <button onclick="saveTicketEdit()">Enregistrer</button>
                <button onclick="closeEditModal()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal pour modifier une catégorie -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content">
            <h2>Modifier la catégorie</h2>
            <input type="text" id="editCategoryName" placeholder="Nouveau nom de la catégorie">
            <div class="modal-buttons">
                <button onclick="saveCategoryEdit()">Enregistrer</button>
                <button onclick="closeEditCategoryModal()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter un ticket -->
    <div id="addTicketModal" class="modal">
        <div class="modal-content">
            <h2>Ajouter un nouveau ticket</h2>
            <input type="text" id="newPassword" placeholder="Mot de passe">
            <input type="text" id="newPrice" placeholder="Prix">
            <input type="text" id="newUser" placeholder="Utilisateur">
            <div class="modal-buttons">
                <button onclick="saveNewTicket()">Ajouter</button>
                <button onclick="closeAddTicketModal()">Annuler</button>
            </div>
        </div>
    </div>

    <script>

        
const firebaseConfig = {
  apiKey: "AIzaSyDzNd9m8S5d1TgtMuEiAukVve8XZ2kt-aY",
  authDomain: "alimos-3a8fa.firebaseapp.com",
  databaseURL: "https://alimos-3a8fa-default-rtdb.firebaseio.com",
  projectId: "alimos-3a8fa",
  storageBucket: "alimos-3a8fa.firebasestorage.app",
  messagingSenderId: "408322448178",
  appId: "1:408322448178:web:84bd88711e2935ae89d52b",
  measurementId: "G-1KJZBB0802"
};

        // Initialisation de Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allTickets = {};
        let tempImportData = null;
        let tempCategory = null;
        let currentEditingTicket = null;
        let currentEditingCategory = null;

        // Variables pour stocker les informations d'édition
        let editingCategory = '';
        let editingIndex = -1;

            // Vérification immédiate avant tout chargement
    (function() {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        if (!isLoggedIn) {
            window.location.replace('login.html');
        }
    })();

    // Vérification continue pendant la session
    document.addEventListener('DOMContentLoaded', function() {
        if (!sessionStorage.getItem('isLoggedIn')) {
            window.location.replace('login.html');
        }
    });

    // Empêcher le retour à la page après déconnexion
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || !sessionStorage.getItem('isLoggedIn')) {
            window.location.replace('login.html');
        }
    });

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function loadTickets() {
            showLoading();
            const ticketsRef = database.ref('TicketsTotal');
            ticketsRef.on('value', (snapshot) => {
                allTickets = snapshot.val();
                displayTickets(allTickets);
                hideLoading();
            }, (error) => {
                console.error("Erreur lors du chargement des tickets:", error);
                hideLoading();
                alert("Erreur lors du chargement des tickets. Veuillez réessayer.");
            });
        }

        function displayTickets(tickets, searchTerm = '') {
            const categoriesContainer = document.getElementById('ticketCategories');
            categoriesContainer.innerHTML = '';
            
            for (let category in tickets) {
                const categoryTickets = tickets[category];
                const categoryHtml = `
                    <div class="category-section">
                        <div class="category-header">
                            <div class="category-title">
                                <h2>${category}</h2>
                                <i class="fas fa-thumbtack pin-icon" onclick="editCategory('${category}')"></i>
                            </div>
                            <div>
                                <button class="add-ticket-btn" onclick="showAddTicketModal('${category}')">
                                    <i class="fas fa-plus"></i> Ajouter un ticket
                                </button>
                                <label for="importFile_${category}" class="file-input-label">
                                    <i class="fas fa-file-import"></i> Importer dans ${category}
                                </label>
                                <input type="file" id="importFile_${category}" 
                                    accept=".json,.csv,.txt" 
                                    style="display: none;" 
                                    onchange="importTicketsToCategory('${category}', event)">
                            </div>
                        </div>
                        <button onclick="deleteAllTicketsInCategory('${category}')">Supprimer tous les tickets de ${category}</button>
                        <table>
                            <thead>
                                <tr>
                                    <th>Sélectionner</th>
                                    <th>Mot de passe</th>
                                    <th>Prix</th>
                                    <th>Utilisateur</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ticketsBody_${category}">
                            </tbody>
                        </table>
                        <button onclick="deleteSelectedTickets('${category}')">Supprimer les tickets sélectionnés de ${category}</button>
                    </div>
                `;
                categoriesContainer.innerHTML += categoryHtml;

                const ticketsBody = document.getElementById(`ticketsBody_${category}`);
                for (let i = 0; i < categoryTickets.motDePasse.length; i++) {
                    if (searchTerm && !matchesSearch(categoryTickets, i, searchTerm)) continue;
                    const row = `
                        <tr>
                            <td><input type="checkbox" name="ticketSelect_${category}" value="${i}"></td>
                            <td>${highlightMatch(categoryTickets.motDePasse[i], searchTerm)}</td>
                            <td>${highlightMatch(categoryTickets.prix[i], searchTerm)}</td>
                            <td>${highlightMatch(categoryTickets.utilisateur[i], searchTerm)}</td>
                            <td>
                                <button class="edit-btn" onclick="editTicket('${category}', ${i})">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button class="delete-btn" onclick="deleteTicket('${category}', ${i})">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </td>
                        </tr>
                    `;
                    ticketsBody.innerHTML += row;
                }
            }
        }

        function editTicket(category, index) {
            editingCategory = category;
            editingIndex = index;
            const ticket = allTickets[category];
            
            document.getElementById('editPassword').value = ticket.motDePasse[index];
            document.getElementById('editPrice').value = ticket.prix[index];
            document.getElementById('editUser').value = ticket.utilisateur[index];
            
            document.getElementById('editTicketModal').style.display = 'block';
        }

        function saveTicketEdit() {
            const newPassword = document.getElementById('editPassword').value;
            const newPrice = document.getElementById('editPrice').value;
            const newUser = document.getElementById('editUser').value;

            if (!newPassword || !newPrice || !newUser) {
                alert('Tous les champs sont obligatoires');
                return;
            }

            showLoading();
            const updates = {};
            const categoryData = allTickets[editingCategory];
            
            categoryData.motDePasse[editingIndex] = newPassword;
            categoryData.prix[editingIndex] = newPrice;
            categoryData.utilisateur[editingIndex] = newUser;

            updates[`TicketsTotal/${editingCategory}`] = categoryData;

            database.ref().update(updates)
                .then(() => {
                    hideLoading();
                    closeEditModal();
                    alert('Ticket modifié avec succès!');
                })
                .catch(error => {
                    console.error("Erreur lors de la modification:", error);
                    hideLoading();
                    alert('Erreur lors de la modification du ticket');
                });
        }

        function importTicketsToCategory(category, event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    if (fileExtension === 'json') {
                        handleJsonImportToCategory(e.target.result, category);
                    } else if (fileExtension === 'csv') {
                        handleCsvImportToCategory(e.target.result, category);
                    } else if (fileExtension === 'txt') {
                        handleTxtImportToCategory(e.target.result, category);
                    } else {
                        throw new Error('Format de fichier non supporté');
                    }
                } catch (error) {
                    console.error('Erreur d\'importation:', error);
                    hideLoading();
                    alert('Erreur lors de l\'importation. Veuillez vérifier le format du fichier.');
                }
            };
            reader.readAsText(file);
        }

        function handleJsonImportToCategory(jsonContent, category) {
            const importedData = JSON.parse(jsonContent);
            
            // Si le JSON contient directement les tableaux de tickets
            let ticketsToImport;
            if (importedData.motDePasse) {
                ticketsToImport = importedData;
            } 
            // Si le JSON contient des catégories
            else if (importedData[category]) {
                ticketsToImport = importedData[category];
            } else {
                hideLoading();
                alert('Format JSON invalide ou catégorie non trouvée');
                return;
            }

            mergeTicketsToCategory(category, ticketsToImport);
        }

        function handleCsvImportToCategory(csvContent, category) {
            const lines = csvContent.split('\n');
            const tickets = {
                motDePasse: [],
                prix: [],
                utilisateur: []
            };

            // Skip header line
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                tickets.utilisateur.push(values[0].trim());
                tickets.motDePasse.push(values[1].trim());
                if (values[3]) { // Si le prix est inclus dans le CSV
                    tickets.prix.push(values[3].trim());
                }
            }

            if (!tickets.prix.length) {
                tempImportData = { [category]: tickets };
                tempCategory = category;
                showPriceModal(category);
            } else {
                mergeTicketsToCategory(category, tickets);
            }
        }

        function handleTxtImportToCategory(txtContent, category) {
            const lines = txtContent.split('\n');
            const tickets = {
                motDePasse: [],
                prix: [],
                utilisateur: []
            };
            const regex = /add name="([^"]+)" password="([^"]+)"/;

            for (let line of lines) {
                line = line.trim();
                if (!line || line === '/ip hotspot user') continue;

                const match = line.match(regex);
                if (match) {
                    const [_, name, password] = match;
                    tickets.utilisateur.push(name);
                    tickets.motDePasse.push(password);
                }
            }

            if (tickets.motDePasse.length > 0) {
                tempImportData = { [category]: tickets };
                tempCategory = category;
                showPriceModal(category);
            } else {
                hideLoading();
                alert('Aucun ticket valide trouvé dans le fichier');
            }
        }

        function mergeTicketsToCategory(category, newTickets) {
            if (!allTickets[category]) {
                allTickets[category] = {
                    motDePasse: [],
                    prix: [],
                    utilisateur: []
                };
            }

            const currentTickets = allTickets[category];
            
            const mergedTickets = {
                motDePasse: [...currentTickets.motDePasse, ...newTickets.motDePasse],
                prix: [...currentTickets.prix, ...newTickets.prix],
                utilisateur: [...currentTickets.utilisateur, ...newTickets.utilisateur]
            };

            database.ref(`TicketsTotal/${category}`).set(mergedTickets)
                .then(() => {
                    hideLoading();
                    alert(`Importation réussie dans la catégorie ${category} ! Les nouveaux tickets ont été ajoutés aux existants.`);
                })
                .catch((error) => {
                    console.error("Erreur lors de l'importation:", error);
                    hideLoading();
                    alert("Erreur lors de l'importation. Veuillez réessayer.");
                });
        }

        function editCategory(category) {
            currentEditingCategory = category;
            document.getElementById('editCategoryName').value = category;
            document.getElementById('editCategoryModal').style.display = 'block';
        }

        function saveCategoryEdit() {
            const newCategoryName = document.getElementById('editCategoryName').value.trim();
            
            if (!newCategoryName) {
                alert('Le nom de la catégorie ne peut pas être vide');
                return;
            }

            if (newCategoryName === currentEditingCategory) {
                closeEditCategoryModal();
                return;
            }

            showLoading();
            const categoryData = allTickets[currentEditingCategory];
            
            const updates = {
                [`TicketsTotal/${currentEditingCategory}`]: null,
                [`TicketsTotal/${newCategoryName}`]: categoryData
            };

            database.ref().update(updates)
                .then(() => {
                    hideLoading();
                    closeEditCategoryModal();
                    alert('Catégorie modifiée avec succès!');
                })
                .catch(error => {
                    console.error("Erreur lors de la modification de la catégorie:", error);
                    hideLoading();
                    alert('Erreur lors de la modification de la catégorie');
                });
        }

        function showAddTicketModal(category) {
            currentEditingCategory = category;
            document.getElementById('newPassword').value = '';
            document.getElementById('newPrice').value = '';
            document.getElementById('newUser').value = '';
            document.getElementById('addTicketModal').style.display = 'block';
        }

        function saveNewTicket() {
            const password = document.getElementById('newPassword').value.trim();
            const price = document.getElementById('newPrice').value.trim();
            const user = document.getElementById('newUser').value.trim();

            if (!password || !price || !user) {
                alert('Tous les champs sont obligatoires');
                return;
            }

            showLoading();
            const categoryData = allTickets[currentEditingCategory];
            
            categoryData.motDePasse.push(password);
            categoryData.prix.push(price);
            categoryData.utilisateur.push(user);

            database.ref(`TicketsTotal/${currentEditingCategory}`).set(categoryData)
                .then(() => {
                    hideLoading();
                    closeAddTicketModal();
                    alert('Ticket ajouté avec succès!');
                })
                .catch(error => {
                    console.error("Erreur lors de l'ajout du ticket:", error);
                    hideLoading();
                    alert('Erreur lors de l\'ajout du ticket');
                });
        }

        function closeEditModal() {
            document.getElementById('editTicketModal').style.display = 'none';
            editingCategory = '';
            editingIndex = -1;
        }

        function closeEditCategoryModal() {
            document.getElementById('editCategoryModal').style.display = 'none';
            currentEditingCategory = null;
        }

        function closeAddTicketModal() {
            document.getElementById('addTicketModal').style.display = 'none';
            currentEditingCategory = null;
        }

        function matchesSearch(categoryTickets, index, searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase();
            return categoryTickets.motDePasse[index].toLowerCase().includes(lowerSearchTerm) ||
                   categoryTickets.prix[index].toLowerCase().includes(lowerSearchTerm) ||
                   categoryTickets.utilisateur[index].toLowerCase().includes(lowerSearchTerm);
        }

        function highlightMatch(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(searchTerm, 'gi');
            return text.replace(regex, match => `<span class="highlight">${match}</span>`);
        }

        function deleteTicket(category, index) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce ticket ?')) {
                showLoading();
                const categoryData = allTickets[category];
                categoryData.motDePasse.splice(index, 1);
                categoryData.prix.splice(index, 1);
                categoryData.utilisateur.splice(index, 1);
                
                database.ref(`TicketsTotal/${category}`).set(categoryData)
                    .then(() => {
                        hideLoading();
                        alert('Ticket supprimé avec succès!');
                    })
                    .catch(error => {
                        console.error("Erreur lors de la suppression:", error);
                        hideLoading();
                        alert('Erreur lors de la suppression du ticket');
                    });
            }
        }

        function deleteSelectedTickets(category) {
            const selectedTickets = document.querySelectorAll(`input[name="ticketSelect_${category}"]:checked`);
            if (selectedTickets.length === 0) {
                alert('Veuillez sélectionner au moins un ticket à supprimer');
                return;
            }

            if (confirm('Êtes-vous sûr de vouloir supprimer les tickets sélectionnés ?')) {
                showLoading();
                const categoryData = allTickets[category];
                const indices = Array.from(selectedTickets)
                    .map(checkbox => parseInt(checkbox.value))
                    .sort((a, b) => b - a);

                indices.forEach(index => {
                    categoryData.motDePasse.splice(index, 1);
                    categoryData.prix.splice(index, 1);
                    categoryData.utilisateur.splice(index, 1);
                });

                database.ref(`TicketsTotal/${category}`).set(categoryData)
                    .then(() => {
                        hideLoading();
                        alert('Tickets sélectionnés supprimés avec succès!');
                    })
                    .catch(error => {
                        console.error("Erreur lors de la suppression:", error);
                        hideLoading();
                        alert('Erreur lors de la suppression des tickets');
                    });
            }
        }

        function deleteAllTicketsInCategory(category) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer TOUS les tickets de la catégorie ${category} ?`)) {
                showLoading();
                database.ref(`TicketsTotal/${category}`).set({
                    motDePasse: [],
                    prix: [],
                    utilisateur: []
                })
                .then(() => {
                    hideLoading();
                    alert('Tous les tickets de la catégorie ont été supprimés avec succès!');
                })
                .catch(error => {
                    console.error("Erreur lors de la suppression:", error);
                    hideLoading();
                    alert('Erreur lors de la suppression des tickets');
                });
            }
        }

        function exportTickets() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allTickets, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "tickets_export.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function exportFilteredTickets() {
            const searchTerm = document.getElementById('searchBar').value.trim();
            const filteredTickets = {};
            
            for (let category in allTickets) {
                const categoryTickets = allTickets[category];
                filteredTickets[category] = {
                    motDePasse: [],
                    prix: [],
                    utilisateur: []
                };
                
                for (let i = 0; i < categoryTickets.motDePasse.length; i++) {
                    if (!searchTerm || matchesSearch(categoryTickets, i, searchTerm)) {
                        filteredTickets[category].motDePasse.push(categoryTickets.motDePasse[i]);
                        filteredTickets[category].prix.push(categoryTickets.prix[i]);
                        filteredTickets[category].utilisateur.push(categoryTickets.utilisateur[i]);
                    }
                }
            }
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(filteredTickets, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "filtered_tickets_export.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function handleJsonImport(jsonContent) {
            const importedData = JSON.parse(jsonContent);
            if (confirm('Êtes-vous sûr de vouloir importer ces tickets ? Les nouveaux tickets seront ajoutés aux tickets existants.')) {
                const updates = {};
                for (let category in importedData) {
                    if (allTickets[category]) {
                        // Fusion des tickets existants avec les nouveaux
                        updates[`TicketsTotal/${category}`] = {
                            motDePasse: [...allTickets[category].motDePasse, ...importedData[category].motDePasse],
                            prix: [...allTickets[category].prix, ...importedData[category].prix],
                            utilisateur: [...allTickets[category].utilisateur, ...importedData[category].utilisateur]
                        };
                    } else {
                        // Nouvelle catégorie
                        updates[`TicketsTotal/${category}`] = importedData[category];
                    }
                }
                database.ref().update(updates)
                    .then(() => {
                        hideLoading();
                        alert('Importation réussie !');
                    })
                    .catch((error) => {
                        console.error("Erreur lors de l'importation:", error);
                        hideLoading();
                        alert("Erreur lors de l'importation. Veuillez réessayer.");
                    });
            } else {
                hideLoading();
            }
        }

        function handleCsvImport(csvContent) {
            const lines = csvContent.split('\n');
            const tickets = {};

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const category = values[2].trim(); // Profile column

                if (!tickets[category]) {
                    tickets[category] = {
                        motDePasse: [],
                        prix: [],
                        utilisateur: []
                    };
                }

                tickets[category].utilisateur.push(values[0].trim());
                tickets[category].motDePasse.push(values[1].trim());
            }

            tempImportData = tickets;
            const firstCategory = Object.keys(tickets)[0];
            showPriceModal(firstCategory);
        }

        function handleTxtImport(txtContent) {
            const lines = txtContent.split('\n');
            const tickets = {};
            const regex = /add name="([^"]+)" password="([^"]+)" profile="([^"]+)"/;

            for (let line of lines) {
                line = line.trim();
                if (!line || line === '/ip hotspot user') continue;

                const match = line.match(regex);
                if (match) {
                    const [_, name, password, profile] = match;
                    if (!tickets[profile]) {
                        tickets[profile] = {
                            motDePasse: [],
                            prix: [],
                            utilisateur: []
                        };
                    }

                    tickets[profile].utilisateur.push(name);
                    tickets[profile].motDePasse.push(password);
                }
            }

            if (Object.keys(tickets).length === 0) {
                hideLoading();
                alert('Aucun ticket valide n\'a été trouvé dans le fichier');
                return;
            }

            tempImportData = tickets;
            const firstCategory = Object.keys(tickets)[0];
            showPriceModal(firstCategory);
        }

        function showPriceModal(category) {
            tempCategory = category;
            document.getElementById('categoryName').textContent = category;
            document.getElementById('priceModal').style.display = 'block';
        }

        function confirmPrice() {
            const price = document.getElementById('priceInput').value.trim();
            
            if (!price) {
                alert('Veuillez entrer un prix');
                return;
            }

            tempImportData[tempCategory].prix = Array(tempImportData[tempCategory].motDePasse.length).fill(price);

            const categories = Object.keys(tempImportData);
            const currentIndex = categories.indexOf(tempCategory);
            
            if (currentIndex < categories.length - 1) {
                document.getElementById('priceInput').value = '';
                showPriceModal(categories[currentIndex + 1]);
            } else {
                finishImport();
            }
        }

        function cancelImport() {
            document.getElementById('priceModal').style.display = 'none';
            document.getElementById('importFile').value = '';
            tempImportData = null;
            tempCategory = null;
            hideLoading();
        }

        function finishImport() {
            if (confirm('Êtes-vous sûr de vouloir importer ces tickets ? Les nouveaux tickets seront ajoutés aux tickets existants.')) {
                const updates = {};
                for (let category in tempImportData) {
                    if (allTickets[category]) {
                        // Fusion des tickets existants avec les nouveaux
                        updates[`TicketsTotal/${category}`] = {
                            motDePasse: [...allTickets[category].motDePasse, ...tempImportData[category].motDePasse],
                            prix: [...allTickets[category].prix, ...tempImportData[category].prix],
                            utilisateur: [...allTickets[category].utilisateur, ...tempImportData[category].utilisateur]
                        };
                    } else {
                        // Nouvelle catégorie
                        updates[`TicketsTotal/${category}`] = tempImportData[category];
                    }
                }
                
                database.ref().update(updates)
                    .then(() => {
                        document.getElementById('priceModal').style.display = 'none';
                        document.getElementById('importFile').value = '';
                        tempImportData = null;
                        tempCategory = null;
                        hideLoading();
                        alert('Importation réussie !');
                    })
                    .catch((error) => {
                        console.error("Erreur lors de l'importation:", error);
                        hideLoading();
                        alert("Erreur lors de l'importation. Veuillez réessayer.");
                    });
            } else {
                cancelImport();
            }
        }

        function importTickets(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    if (fileExtension === 'json') {
                        handleJsonImport(e.target.result);
                    } else if (fileExtension === 'csv') {
                        handleCsvImport(e.target.result);
                    } else if (fileExtension === 'txt') {
                        handleTxtImport(e.target.result);
                    } else {
                        throw new Error('Format de fichier non supporté');
                    }
                } catch (error) {
                    console.error('Erreur d\'importation:', error);
                    hideLoading();
                    alert('Erreur lors de l\'importation. Veuillez vérifier le format du fichier.');
                }
            };
            reader.readAsText(file);
        }

        function deleteSearchResults() {
            const searchTerm = document.getElementById('searchBar').value.trim();
            if (!searchTerm) {
                alert('Veuillez entrer un terme de recherche avant de supprimer.');
                return;
            }

            if (confirm('Êtes-vous sûr de vouloir supprimer tous les tickets correspondant à votre recherche ?')) {
                showLoading();
                const updates = {};
                for (let category in allTickets) {
                    const categoryTickets = allTickets[category];
                    const newCategoryData = {
                        motDePasse: [],
                        prix: [],
                        utilisateur: []
                    };
                    
                    for (let i = 0; i < categoryTickets.motDePasse.length; i++) {
                        if (!matchesSearch(categoryTickets, i, searchTerm)) {
                            newCategoryData.motDePasse.push(categoryTickets.motDePasse[i]);
                            newCategoryData.prix.push(categoryTickets.prix[i]);
                            newCategoryData.utilisateur.push(categoryTickets.utilisateur[i]);
                        }
                    }
                    updates[`TicketsTotal/${category}`] = newCategoryData;
                }
                
                database.ref().update(updates)
                    .then(() => {
                        hideLoading();
                        alert('Les tickets correspondant à la recherche ont été supprimés.');
                    })
                    .catch((error) => {
                        console.error("Erreur lors de la suppression des résultats de recherche:", error);
                        hideLoading();
                        alert("Erreur lors de la suppression des résultats de recherche. Veuillez réessayer.");
                    });
            }
        }

        function searchTickets() {
            const searchTerm = document.getElementById('searchBar').value.trim();
            displayTickets(allTickets, searchTerm);
        }

        // Ajoutez ce code au début de votre script existant, juste après la déclaration des variables

        function checkAuth() {
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
    
    if (!isLoggedIn) {
        window.location.replace('login.html');
        return false;
    }
    
    return true;
}

// Modifiez la fonction window.onload
window.onload = () => {
    if (checkAuth()) {
        loadTickets();
    }
};

// Fonction de déconnexion améliorée
function logout() {
    sessionStorage.clear(); // Nettoie toutes les données de session
    window.location.replace('login.html');
}


        // Écouteur d'événement pour la recherche
        document.getElementById('searchBar').addEventListener('input', searchTickets);

        // Chargement initial des tickets
        window.onload = loadTickets;
    </script>
</body>
</html>
