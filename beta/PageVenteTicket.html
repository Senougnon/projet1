<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vente Tickets Cyber Campus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ... (Styles CSS - Pas de modifications ici) ... */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #970158, #00026e, #000000);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #fff;
            overflow-x: hidden;
            font-size: 16px;
            line-height: 1.5;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        section {
            margin: 16px 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        section:hover{
            transform: translateY(-5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #fdbb2d;
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: white;
            margin-top: 16px;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        td{
            transition: background-color 0.3s ease;
        }
        tr:hover td{
            background-color: rgba(255, 255, 255, 0.1);
        }

        button {
            background-color: #fdbb2d;
            color: #1a2a6c;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            touch-action: manipulation;
        }

        button:active {
            transform: scale(0.95);
        }

        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            color: #1a2a6c;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .notification h3 {
            margin-bottom: 16px;
            color: #1a2a6c;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .ticket-details {
            margin: 16px 0;
            font-size: 0.95rem;
        }

        .ticket-details p {
            margin: 8px 0;
            word-break: break-word;
        }

        .action-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }

        .action-icon {
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
        }

        .action-icon:active {
            transform: scale(0.9);
        }

        .icon-share { color: #4CAF50; }
        .icon-copy { color: #2196F3; }
        .icon-pdf { color: #f44336; }

        .buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-sell {
            background-color: #4CAF50;
            color: white;
            flex: 1;
            min-width: 120px;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
            flex: 1;
            min-width: 120px;
        }

        .close-icon {
            position: absolute;
            top: 12px;
            right: 12px;
            cursor: pointer;
            font-size: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.05);
        }

        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            display: none;
            z-index: 1001;
            text-align: center;
            max-width: 200px;
            left: 50% !important;
            transform: translateX(-50%);
            bottom: 24px;
        }
        .history-section {
            display: none;
            background: rgba(26, 42, 108, 0.95); /* Fond plus opaque avec une teinte bleue foncée */
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .history-section:hover{
            transform: translate(-50%, -50%) translateY(-5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Amélioration du style de l'en-tête de l'historique pour plus de lisibilité */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: inherit;
            padding: 10px 0;
            z-index: 1;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Amélioration de la lisibilité des cartes de statistiques */
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover{
            transform: translateY(-5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card h4 {
            color: #fdbb2d;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .toggle-history {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #fdbb2d;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .toggle-history i{
            transition: transform 0.3s ease;
        }
        .toggle-history:hover{
            transform: scale(1.1);
        }
        .toggle-history:hover i{
            transform: rotate(180deg);
        }

        .toggle-history:active {
            transform: scale(0.95);
        }

        .date-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .date-filter select {
            padding: 8px;
            border-radius: 4px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
        }

        footer {
            margin-top: auto;
            text-align: center;
            padding: 16px;
            background-color: rgba(0, 0, 0, 0.5);
            font-size: 0.9rem;
        }

        /* Media Queries */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .container {
                padding: 12px;
            }

            section {
                padding: 12px;
                margin: 12px 0;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 8px 6px;
            }

            td:last-child {
                text-align: right;
            }

            button {
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .notification {
                padding: 20px 16px;
                width: 95%;
            }

            .action-icons {
                gap: 16px;
            }

            .action-icon {
                width: 40px;
                height: 40px;
                padding: 10px;
            }

            .buttons button {
                flex: 1;
                min-width: 0;
            }

            .close-icon {
                top: 8px;
                right: 8px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .history-table {
                font-size: 0.8rem;
            }

            .date-filter {
                flex-direction: column;
            }
        }

        @media (max-width: 320px) {
            .buttons {
                flex-direction: column;
            }

            .action-icons {
                gap: 12px;
            }

            .action-icon {
                width: 36px;
                height: 36px;
            }
        }

        .login-section {
            margin: 16px 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .login-section h2 {
            color: #fdbb2d;
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
        }

        .login-section input[type="text"],
        .login-section input[type="password"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .login-section button {
            background-color: #fdbb2d;
            color: #1a2a6c;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
            width: 100%;
            margin-top: 10px;
        }

        .login-section button:active {
            transform: scale(0.95);
        }

        .error-message {
            margin-top: 10px;
            text-align: center;
        }
        .messages-section {
            margin: 16px 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            max-height: 300px; /* Hauteur maximale pour la section des messages */
            overflow-y: auto; /* Permettre le défilement vertical si le contenu dépasse la hauteur maximale */
        }

        .messages-section h2 {
            color: #fdbb2d;
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
        }

        .message {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
        }

        .message .timestamp {
            font-size: 0.7rem;
            color: #ccc;
            margin-top: 5px;
        }

        /* Styles pour l'autocomplétion */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #ccc;
            list-style: none;
            padding: 0;
            margin: 0;
            z-index: 100;
            background-color: white;
            width: 100%; /* Assurez-vous que la liste a la même largeur que le champ de saisie */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Ombre pour un effet visuel */
        }

        .autocomplete-suggestions li {
            padding: 5px;
            cursor: pointer;
            color: #000;
        }

        .autocomplete-suggestions li:hover {
            background-color: #fdbb2d;
            color: #1a2a6c;
        }
        .loader-wrapper {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
        }

        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #fdbb2d;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .page-loader-wrapper {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1002;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .page-loader {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #fdbb2d;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        .loader-message {
            color: white;
            margin-top: 16px;
            font-size: 1rem;
            text-align: center;
            max-width: 80%;
        }

    </style>
</head>

<body>
    <div class="page-loader-wrapper" id="pageLoaderWrapper">
        <div class="page-loader"></div>
        <div class="loader-message" id="pageLoaderMessage">Initialisation...</div>
    </div>
    <div class="loader-wrapper" id="loaderWrapper">
        <div class="loader"></div>
    </div>
    <section class="login-section" id="loginSection">
        <h2>Connexion Partenaire</h2>
        <form id="loginForm">
            <div class="autocomplete-container">
                <input type="text" id="username" placeholder="Nom d'utilisateur" required>
                <ul class="autocomplete-suggestions" id="autocompleteSuggestions" style="display: none;"></ul>
            </div>
            <input type="password" id="password" placeholder="Mot de passe" required>
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe" style="color: white; margin-left: 5px;">Se souvenir de moi (24h)</label>
            </div>
            <button type="submit">Se connecter</button>
        </form>
        <div class="error-message" id="loginError" style="display: none; color: red;"></div>
    </section>

    <div class="container">
        <section class="rates-section" style="display: none;">
            <h2>Vente de tickets WiFi</h2>
            <div class="loading-message">Chargement des tickets...</div>
            <table style="display: none;"></table>
        </section>
    </div>

    <div class="notification" id="notification">
        <span class="close-icon" onclick="hideNotification()">×</span>
        <h3 id="notification-title">Confirmation de vente</h3>
        <div class="ticket-details" id="notification-message"></div>
        <div class="buttons" id="confirmation-buttons">
            <button class="btn-sell" onclick="window.proceedWithSale()">Confirmer</button>
            <button class="btn-cancel" onclick="hideNotification()">Annuler</button>
        </div>
        <div class="action-icons" id="ticket-actions" style="display: none;">
            <div class="action-icon icon-share" onclick="shareTicket()" title="Partager">
                <i data-lucide="share-2"></i>
            </div>
            <div class="action-icon icon-pdf" onclick="exportToPDF()" title="Exporter en PDF">
                <i data-lucide="file-text"></i>
            </div>
        </div>
    </div>

    <div class="toggle-history" onclick="toggleHistory()">
        <i data-lucide="history"></i>
    </div>

    <div class="history-section" id="historySection" style="display: none;">
        <div class="history-header">
            <h2>Historique des ventes</h2>
            <button onclick="closeHistory()">
                <i data-lucide="x"></i>
            </button>
        </div>

        <div class="date-filter">
            <select id="periodFilter" onchange="filterHistory()">
                <option value="today">Aujourd'hui</option>
                <option value="week">Cette semaine</option>
                <option value="month">Ce mois</option>
                <option value="all">Tout l'historique</option>
            </select>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h4>Tickets vendus</h4>
                <div id="totalTickets" class="value">0</div>
            </div>
            <div class="stat-card">
                <h4>Chiffre d'affaires</h4>
                <div id="totalRevenue" class="value">0 FCFA</div>
            </div>
            <div class="stat-card">
                <h4>Ticket le plus vendu</h4>
                <div id="topCategory" class="value">-</div>
            </div>
            <div class="stat-card">
                <h4>Moyenne par jour</h4>
                <div id="avgDaily" class="value">0</div>
            </div>
        </div>

        <div class="history-table">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Catégorie</th>
                        <th>Utilisateur</th>
                        <th>Prix</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <section class="messages-section" id="messagesSection" style="display: none;">
        <h2>Messages Reçus</h2>
        <div id="messagesContainer">
            <!-- Les messages seront ajoutés ici -->
        </div>
    </section>

    <div id="tooltip" class="tooltip"></div>

    <footer>
        <div class="anitext">PROPULSE PAR EVISIONS</div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6AUBnK_7Vy2ABWI2JMo3ebG_Sljr8XlY",
            authDomain: "cyber-campus-2706f.firebaseapp.com",
            databaseURL: "https://cyber-campus-2706f-default-rtdb.firebaseio.com",
            projectId: "cyber-campus-2706f",
            storageBucket: "cyber-campus-2706f.appspot.com",
            messagingSenderId: "719410601264",
            appId: "1:719410601264:web:44fd2e3757721866303cf5",
            measurementId: "G-CEEFJP5LYZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const adminRef = ref(db, 'admin/subscription');

        // Fonction pour vérifier le statut de l'abonnement
        function checkSubscriptionStatus() {
            onValue(adminRef, (snapshot) => {
                const subscription = snapshot.val();
                if (!subscription || subscription.status !== 'active') {
                    alert("Un abonnement actif est requis pour accéder à cette page.");
                    window.location.href = 'index.html'; // Redirige vers la page d'accueil
                }
            });
        }

        // Vérification de l'abonnement
        function checkSubscription() {
            checkSubscriptionStatus();
            // ... autres initialisations ...
        }

        // Appeler checkSubscription au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            checkSubscription();
        });


    
        let ticketToSell = null;
        let localTickets = {};
        let currentReservedTicket = null;
        let currentVendorId = '';
        let vendors = {}; // Stockera les informations de connexion des partenaires
        let availableUsernames = []; // Liste des noms d'utilisateur disponibles pour l'autocomplétion
        window.jsPDF = window.jspdf.jsPDF;
        // Fonction pour récupérer les informations de connexion des partenaires
        async function fetchVendors() {
            try {
                const vendorsRef = ref(db, 'Vendors');
                const snapshot = await get(vendorsRef);
                if (snapshot.exists()) {
                    vendors = snapshot.val();
                    availableUsernames = Object.keys(vendors); // Mettre à jour la liste des noms d'utilisateur
                } else {
                    console.log("Aucun vendeur trouvé.");
                }
            } catch (error) {
                console.error("Erreur lors de la récupération des vendeurs:", error);
            }
        }
    
// --- Autocomplétion ---
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password'); // Ajout pour le champ de mot de passe
const suggestionsList = document.getElementById('autocompleteSuggestions');

usernameInput.addEventListener('input', () => {
    const inputValue = usernameInput.value.toLowerCase();
    const suggestions = availableUsernames.filter(username => username.toLowerCase().startsWith(inputValue));

    suggestionsList.innerHTML = ''; // Effacer les suggestions précédentes
    if (inputValue.length === 0 || suggestions.length === 0) {
        suggestionsList.style.display = 'none'; // Cacher la liste si aucune suggestion
        return; // Sortir de la fonction si l'input est vide
    }

    suggestions.forEach(suggestion => {
        const listItem = document.createElement('li');
        listItem.textContent = suggestion;
        listItem.addEventListener('click', () => {
            usernameInput.value = suggestion;
            suggestionsList.innerHTML = ''; // Effacer les suggestions
            suggestionsList.style.display = 'none'; // Cacher la liste
        });
        suggestionsList.appendChild(listItem);
    });

    suggestionsList.style.display = 'block'; // Afficher la liste de suggestions
});

// Cacher les suggestions si on clique en dehors
document.addEventListener('click', (event) => {
    if (!usernameInput.contains(event.target) && !suggestionsList.contains(event.target)) {
        suggestionsList.style.display = 'none';
    }
});

// --- Mémorisation de l'ID et du MOT DE PASSE (DÉCONSEILLÉ) ---
const rememberMeCheckbox = document.getElementById('rememberMe');

// Pré-remplir l'ID et le MOT DE PASSE si mémorisés
const storedUsername = localStorage.getItem('username');
const storedPassword = localStorage.getItem('password'); // Ajout pour le mot de passe
const storedTimestamp = localStorage.getItem('usernameTimestamp'); // Le timestamp est commun
const now = Date.now();
const twentyFourHours = 24 * 60 * 60 * 1000;

if (storedUsername && storedPassword && storedTimestamp && (now - storedTimestamp < twentyFourHours)) {
    usernameInput.value = storedUsername;
    passwordInput.value = storedPassword; // Pré-remplir le mot de passe
    rememberMeCheckbox.checked = true; // Cocher la case "Se souvenir de moi"
}

// Gestion du formulaire de connexion
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const ratesSection = document.querySelector('.rates-section');
const historySection = document.getElementById('historySection');
const loginSection = document.getElementById('loginSection');
const messagesSection = document.getElementById('messagesSection');

loginForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    showLoader();
    const username = usernameInput.value;
    const password = passwordInput.value;

    if (vendors[username] && vendors[username].password === password) {
        // Connexion réussie
        loginError.style.display = 'none';
        ratesSection.style.display = 'block';
        historySection.style.display = 'none';
        loginSection.style.display = 'none';
        messagesSection.style.display = 'block';
        currentVendorId = username; // Mettre à jour l'ID du vendeur actuel

        // Mémoriser l'ID et le MOT DE PASSE si la case est cochée (DÉCONSEILLÉ)
        if (rememberMeCheckbox.checked) {
            localStorage.setItem('username', username);
            localStorage.setItem('password', password); // Stocker le mot de passe
            localStorage.setItem('usernameTimestamp', Date.now());
        } else {
            localStorage.removeItem('username');
            localStorage.removeItem('password'); // Supprimer le mot de passe
            localStorage.removeItem('usernameTimestamp');
        }

        // Charger les données et initialiser l'interface
        await syncTickets();
        loadHistory();
        listenForNewMessages();
        lucide.createIcons();
        hideLoader();
    } else {
        // Identifiants incorrects
        loginError.style.display = 'block';
        loginError.textContent = "Nom d'utilisateur ou mot de passe incorrect.";
        hideLoader();
    }
});

    
        // Fonction pour synchroniser les tickets et gérer l'affichage
        async function syncTickets() {
            try {
                const loadingMessage = document.querySelector('.loading-message');
                const table = document.querySelector('.rates-section table');
    
                loadingMessage.style.display = 'block';
                table.style.display = 'none';
    
                const ticketsTotalRef = ref(db, 'TicketsTotal');
                const snapshot = await get(ticketsTotalRef);
    
                if (snapshot.exists()) {
                    localTickets = snapshot.val();
                    createTicketTable();
                    loadingMessage.style.display = 'none';
                    table.style.display = 'table';
                } else {
                    loadingMessage.textContent = 'Aucun ticket disponible.';
                }
            } catch (error) {
                console.error("Erreur de synchronisation:", error);
                loadingMessage.textContent = "Erreur de synchronisation des tickets.";
            }
        }
    
        // Mise à jour de la création du tableau pour afficher uniquement les tickets disponibles avec leur nombre restant
        async function createTicketTable() {
            const table = document.querySelector('.rates-section table');
            table.innerHTML = `
                <tr>
                    <th>Catégorie</th>
                    <th>Prix (FCFA)</th>
                    <th>Restants</th>
                    <th>Action</th>
                </tr>
            `;

            for (const [category, data] of Object.entries(localTickets)) {
                const remaining = data.utilisateur ? data.utilisateur.length : 0;
                if (remaining > 0) {
                    const price = data.prix[0];
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${category}</td>
                        <td>${price}</td>
                        <td>${remaining}</td>
                        <td><button onclick="window.initTicketSale('${category}')">Vendre</button></td>
                    `;
                }
            }

            document.querySelector('.loading-message').style.display = 'none';
            table.style.display = 'table';
        }
    
        // Modification de la fonction initTicketSale pour demander confirmation
        window.initTicketSale = async function(category) {
            showLoader();
            try {
                const ticketsTotalRef = ref(                db, `TicketsTotal/${category}`);
                const snapshot = await get(ticketsTotalRef);
    
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (!data.utilisateur || data.utilisateur.length === 0) {
                        throw new Error("Plus de tickets disponibles");
                    }
    
                    ticketToSell = {
                        category: category,
                        user: data.utilisateur[0],
                        password: data.motDePasse[0],
                        price: data.prix[0],
                        updatedData: {
                            ...data,
                            utilisateur: data.utilisateur.slice(1),
                            motDePasse: data.motDePasse.slice(1),
                            prix: data.prix.slice(1)
                        }
                    };
    
                    showConfirmation(ticketToSell);
                    hideLoader();
                }
            } catch (error) {
                console.error("Erreur:", error);
                showNotification("Erreur", "Impossible de récupérer le ticket");
                hideLoader();
            }
        };
    
        // Fonction pour afficher la confirmation
        function showConfirmation(ticket) {
            const notification = document.getElementById('notification');
            const message = document.getElementById('notification-message');
            const ticketActions = document.getElementById('ticket-actions');
            const confirmationButtons = document.getElementById('confirmation-buttons');
    
            document.getElementById('notification-title').textContent = 'Confirmation de vente';
            message.innerHTML = `
                <p>Voulez-vous vendre ce ticket ?</p>
                <p><strong>Catégorie:</strong> ${ticket.category}</p>
                <p><strong>Prix:</strong> ${ticket.price} FCFA</p>
            `;
    
            confirmationButtons.style.display = 'flex';
            ticketActions.style.display = 'none';
            notification.style.display = 'block';
        }
    
        // Fonction pour procéder à la vente après confirmation
        window.proceedWithSale = async function() {
            showLoader();
            if (!ticketToSell) {
                showNotification("Erreur", "Aucun ticket à vendre");
                hideLoader();
                return;
            }
    
            try {
                // Mettre à jour la base de données
                const ticketsTotalRef = ref(db, `TicketsTotal/${ticketToSell.category}`);
                await set(ticketsTotalRef, ticketToSell.updatedData);
    
                // Ajouter aux tickets vendus
                const ticketsVendusRef = ref(db, 'TicketsVendus');
                await push(ticketsVendusRef, {
                    category: ticketToSell.category,
                    user: ticketToSell.user,
                    password: ticketToSell.password,
                    price: ticketToSell.price,
                    soldAt: Date.now(),
                    vendorId: currentVendorId
                });
    
                // Ajouter à l'historique du vendeur
                const vendorHistoryRef = ref(db, `VendorsHistory/${currentVendorId}`);
                await push(vendorHistoryRef, {
                    category: ticketToSell.category,
                    user: ticketToSell.user,
                    password: ticketToSell.password,
                    price: ticketToSell.price,
                    soldAt: Date.now()
                });
    
                // Afficher les détails du ticket vendu
                showTicketDetails(ticketToSell);
                await syncTickets();
                hideLoader();
            } catch (error) {
                console.error("Erreur lors de la vente:", error);
                showNotification("Erreur", "Impossible de finaliser la vente");
                hideLoader();
            }
    
            ticketToSell = null;
        };
    
        // Fonction pour afficher les détails après la vente
        function showTicketDetails(ticket) {
            const notification = document.getElementById('notification');
            const message = document.getElementById('notification-message');
            const ticketActions = document.getElementById('ticket-actions');
            const confirmationButtons = document.getElementById('confirmation-buttons');
    
            document.getElementById('notification-title').textContent = 'Ticket vendu avec succès';
            message.innerHTML = `
                <p><strong>Catégorie:</strong> ${ticket.category}</p>
                <p><strong>Nom d'utilisateur:</strong> ${ticket.user}</p>
                <p><strong>Mot de passe:</strong> ${ticket.password}</p>
                <p><strong>Prix:</strong> ${ticket.price} FCFA</p>
            `;
    
            confirmationButtons.style.display = 'none';
            ticketActions.style.display = 'flex';
            notification.style.display = 'block';
            lucide.createIcons();
        }
        // Afficher la confirmation de vente
        function showSaleConfirmation(ticket) {
            const notification = document.getElementById('notification');
            const message = document.getElementById('notification-message');
            const buttons = document.getElementById('notification-buttons');
    
            message.innerHTML = `
                <p><strong>Catégorie:</strong> ${ticket.category}</p>
                <p><strong>Nom d'utilisateur:</strong> ${ticket.user}</p>
                <p><strong>Mot de passe:</strong> ${ticket.password}</p>
                <p><strong>Prix:</strong> ${ticket.price} FCFA</p>
            `;
    
            buttons.innerHTML = `
                <button class="btn-sell" onclick="window.confirmSale()">
                    Confirmer la vente
                </button>
                <button class="btn-cancel" onclick="window.cancelSale()">
                    Annuler
                </button>
            `;
    
            notification.style.display = 'block';
            lucide.createIcons();
        }
    
        // Confirmation de la vente
        window.confirmSale = async function() {
            showLoader();
            if (!currentReservedTicket) {
                showNotification("Erreur", "Aucun ticket en cours de vente");
                hideLoader();
                return;
            }
    
            try {
                // Ajouter aux tickets vendus
                const ticketsVendusRef = ref(db, 'TicketsVendus');
                await push(ticketsVendusRef, {
                    ...currentReservedTicket,
                    soldAt: Date.now(),
                    vendorId: currentVendorId
                });
    
                // Ajouter à l'historique du vendeur
                const vendorHistoryRef = ref(db, `VendorsHistory/${currentVendorId}`);
                await push(vendorHistoryRef, {
                    ...currentReservedTicket,
                    soldAt: Date.now()
                });
    
                showNotification("Succès", "Ticket vendu avec succès!");
                currentReservedTicket = null;
                hideNotification();
                await syncTickets();
                hideLoader();
            } catch (error) {
                console.error("Erreur de confirmation:", error);
                showNotification("Erreur", "Erreur lors de la confirmation de la vente");
                hideLoader();
            }
        };
    
        // Annulation de la vente
        window.cancelSale = function() {
            currentReservedTicket = null;
            hideNotification();
        };
    
        // Notifications
        function showNotification(title, message) {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const buttons = document.getElementById('notification-buttons');
            const ticketActions = document.getElementById('ticket-actions');

            notificationTitle.textContent = title;
            notificationMessage.innerHTML = message;

            if (title === "Succès" || title === "Erreur") {
                buttons.style.display = 'none';
                ticketActions.style.display = 'none';
            } else {
                buttons.style.display = 'flex';
                ticketActions.style.display = 'none';
            }

            notification.style.display = 'block';
        }
    
        window.hideNotification = function() {
            document.getElementById('notification').style.display = 'none';
        };
    
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            showPageLoader();
            processConnectedTickets()
                .then(() => {
                  fetchVendors();
                  lucide.createIcons();
                  hidePageLoader();
                })
                .catch((error) => {
                    console.error("Erreur lors du traitement des tickets :", error);
                    hidePageLoader();
                    showNotification("Erreur", "Une erreur est survenue lors de l'initialisation.");
                });
        });
    
        // Chargement de l'historique
        async function loadHistory() {
            showLoader();
            try {
                const historyRef = ref(db, `VendorsHistory/${currentVendorId}`);
                const snapshot = await get(historyRef);
    
                let salesHistory = [];
                if (snapshot.exists()) {
                    salesHistory = Object.entries(snapshot.val()).map(([id, data]) => ({
                        id,
                        ...data
                    }));
                }
                filterHistory(salesHistory);
                hideLoader();
            } catch (error) {
                console.error("Erreur lors du chargement de l'historique:", error);
                showNotification("Erreur", "Impossible de charger l'historique");
                hideLoader();
            }
        }
    
        // Filtrage de l'historique par période
        function filterHistory(salesHistory) {
            const period = document.getElementById('periodFilter').value;
            const now = new Date();
            const startOf = {
                today: new Date(now.setHours(0,0,0,0)),
                week: new Date(now.setDate(now.getDate() - now.getDay())),
                month: new Date(now.setDate(1)),
                all: new Date(0)
            };
    
            const filteredSales = salesHistory.filter(sale =>
                new Date(sale.soldAt) >= startOf[period]
            );
    
            updateStats(filteredSales);
            updateHistoryTable(filteredSales);
        }
    
        // Mise à jour des statistiques
        function updateStats(sales) {
            const totalTickets = sales.length;
            const totalRevenue = sales.reduce((sum, sale) => sum + parseFloat(sale.price), 0);
            
            const categoryCounts = sales.reduce((acc, sale) => {
                acc[sale.category] = (acc[sale.category] || 0) + 1;
                return acc;
            }, {});
            const topCategory = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';
    
            const days = sales.length > 0 ? 
                Math.max(1, Math.ceil((Date.now() - Math.min(...sales.map(s => s.soldAt))) / (1000 * 60 * 60 * 24))) : 1;
            const avgDaily = (totalTickets / days).toFixed(1);
    
            document.getElementById('totalTickets').textContent = totalTickets;
            document.getElementById('totalRevenue').textContent = `${totalRevenue.toLocaleString()} FCFA`;
            document.getElementById('topCategory').textContent = topCategory;
            document.getElementById('avgDaily').textContent = avgDaily;
        }
    
        // Mise à jour du tableau d'historique
        function updateHistoryTable(sales) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = sales
                .sort((a, b) => b.soldAt - a.soldAt)
                .map(sale => `
                    <tr onclick="window.showTicketDetailsFromHistory('${sale.id}')" style="cursor: pointer;">
                        <td>${new Date(sale.soldAt).toLocaleString()}</td>
                        <td>${sale.category}</td>
                        <td>${sale.user}</td>
                        <td>${sale.price} FCFA</td>
                        <td><i class="fa-solid fa-arrow-right"></i></td>
                    </tr>
                `).join('');
        }

        window.showTicketDetailsFromHistory = async function(saleId){
            showLoader();
            try{
                const historyRef = ref(db, `VendorsHistory/${currentVendorId}/${saleId}`);
                const snapshot = await get(historyRef);
                if (snapshot.exists()) {
                    const sale = snapshot.val();
                    window.closeHistory();
                    showTicketDetails(sale);
                    hideLoader();
                } else {
                    showNotification("Erreur", "Ticket introuvable dans l'historique");
                    hideLoader();
                }
            }catch (error){
                console.error("Erreur lors de la récupération du ticket:", error);
                showNotification("Erreur", "Impossible de récupérer les détails du ticket");
                hideLoader();
            }
        }
    
        // Gestionnaire pour le bouton d'historique
        window.toggleHistory = function() {
            const historySection = document.getElementById('historySection');
            const isVisible = historySection.style.display === 'block';
            historySection.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                loadHistory();
            }
        };
    
        window.closeHistory = function() {
            document.getElementById('historySection').style.display = 'none';
        };
    
        // Ajouter la fonction de filtrage à window pour l'accès depuis le HTML
        window.filterHistory = function() {
            loadHistory();
        };
    
        // Fonction pour écouter les nouveaux messages
        function listenForNewMessages() {
            const messagesRef = ref(db, `Vendors/${currentVendorId}/messages`);
    
            onChildAdded(messagesRef, (snapshot) => {
                const message = snapshot.val();
                displayNewMessage(message);
            });
        }
    
        // Fonction pour afficher un nouveau message
        function displayNewMessage(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.innerHTML = `
                <p>${message.content}</p>
                <span class="timestamp">${new Date(message.timestamp).toLocaleString()}</span>
            `;
            messagesContainer.appendChild(messageElement);
    
            // Scroll vers le bas pour afficher le dernier message
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        // Fonction pour partager un ticket 
        window.shareTicket = function() {
            const ticketDetails = document.getElementById('notification-message').innerText;
            if (navigator.share) {
                navigator.share({
                    title: 'Détails du Ticket',
                    text: ticketDetails,
                })
                .then(() => console.log('Partage réussi'))
                .catch((error) => console.error('Erreur lors du partage:', error));
            } else {
                // Méthode alternative si navigator.share n'est pas supporté
                alert("Le partage n'est pas supporté sur votre navigateur. Veuillez copier manuellement les détails du ticket.");
            }
        };

        // Fonction pour copier un ticket dans le presse-papiers
        window.copyTicket = function() {
            const ticketDetails = document.getElementById('notification-message').innerText;
            navigator.clipboard.writeText(ticketDetails)
                .then(() => {
                    showNotification("Succès", "Ticket copié dans le presse-papiers!");
                })
                .catch(err => {
                    console.error("Erreur lors de la copie:", err);
                    showNotification("Erreur", "Impossible de copier le ticket");
                });
        };

        // Fonction pour exporter un ticket en PDF
        window.exportToPDF = async function() {
            showLoader();
            const ticketDetails = document.getElementById('notification-message');
            const pdf = new jsPDF();
            
            // Convertir le HTML en canvas
            const canvas = await html2canvas(ticketDetails);
            const imgData = canvas.toDataURL('image/png');

            // Ajouter l'image au PDF
            pdf.addImage(imgData, 'PNG', 10, 10, 190, 0);

            // Sauvegarder le PDF
            pdf.save('ticket.pdf');
            hideLoader();
        };

        function showLoader() {
            document.getElementById('loaderWrapper').style.display = 'block';
        }

        function hideLoader() {
            document.getElementById('loaderWrapper').style.display = 'none';
        }

        function showPageLoader() {
            document.getElementById('pageLoaderWrapper').style.display = 'flex';
        }

        function hidePageLoader() {
            document.getElementById('pageLoaderWrapper').style.display = 'none';
        }

        async function processConnectedTickets() {
            const pageLoaderMessage = document.getElementById('pageLoaderMessage');
            try {
                pageLoaderMessage.textContent = "Vérification des tickets connectés...";
                const connectedTicketsRef = ref(db, 'TicketConnecté');
                const snapshot = await get(connectedTicketsRef);
                let connectedTickets = snapshot.val() || {};

                // Supprimer les doublons et récupérer les informations complètes des tickets
                const uniqueTickets = {};
                for (const ticketId in connectedTickets) {
                    const user = connectedTickets[ticketId].username;
                    if (!uniqueTickets[user]) {
                        uniqueTickets[user] = connectedTickets[ticketId];
                    }
                }
                
                pageLoaderMessage.textContent = "Traitement des tickets uniques...";
                for (const user in uniqueTickets) {
                    await processTicket(uniqueTickets[user]);
                }
                
                pageLoaderMessage.textContent = "Nettoyage des tickets traités...";
                // Nettoyer les tickets traités de TicketConnecté
                for (const user in uniqueTickets) {
                    const ticketId = Object.keys(connectedTickets).find(key => connectedTickets[key].username === user);
                    if (ticketId) {
                        await remove(ref(db, `TicketConnecté/${ticketId}`));
                    }
                }

            } catch (error) {
                console.error("Erreur lors du traitement des tickets connectés :", error);
                showNotification("Erreur", "Une erreur est survenue lors du traitement des tickets.");
            }
        }

        async function processTicket(ticket) {
            const pageLoaderMessage = document.getElementById('pageLoaderMessage');
            try {
                pageLoaderMessage.textContent = `Vérification du ticket pour ${ticket.username}...`;

                // Vérifier dans VendorsHistory
                const vendorsHistoryRef = ref(db, 'VendorsHistory');
                const vendorsHistorySnapshot = await get(vendorsHistoryRef);
                const vendorsHistory = vendorsHistorySnapshot.val() || {};

                let foundInHistory = false;
                for (const vendorId in vendorsHistory) {
                    const vendorHistory = vendorsHistory[vendorId];
                    for (const saleId in vendorHistory) {
                        if (vendorHistory[saleId].user === ticket.username) {
                            foundInHistory = true;
                            break;
                        }
                    }
                    if (foundInHistory) break;
                }

                if (!foundInHistory) {
                    pageLoaderMessage.textContent = `Traitement du ticket ${ticket.username}...`;

                    // Vérifier dans TicketsTotal et TicketsTransit
                    const ticketsTotalRef = ref(db, 'TicketsTotal');
                    const ticketsTransitRef = ref(db, 'TicketsTransit');
                    const totalSnapshot = await get(ticketsTotalRef);
                    const transitSnapshot = await get(ticketsTransitRef);
                    const totalTickets = totalSnapshot.val() || {};
                    const transitTickets = transitSnapshot.val() || {};

                    let foundTicket = null;
                    let foundTicketRef = null;
                    let foundInCategory = null;

                    // Chercher dans TicketsTotal
                    for (const category in totalTickets) {
                        const ticketIndex = (totalTickets[category].utilisateur || []).indexOf(ticket.username);
                        
                        if (ticketIndex > -1) {
                            foundTicket = {
                                category: category,
                                user: totalTickets[category].utilisateur[ticketIndex],
                                password: totalTickets[category].motDePasse[ticketIndex],
                                price: totalTickets[category].prix[ticketIndex],
                                updatedData: {
                                    ...totalTickets[category],
                                    utilisateur: totalTickets[category].utilisateur.filter((_, index) => index !== ticketIndex),
                                    motDePasse: totalTickets[category].motDePasse.filter((_, index) => index !== ticketIndex),
                                    prix: totalTickets[category].prix.filter((_, index) => index !== ticketIndex)
                                }
                            };
                            foundTicketRef = ref(db, `TicketsTotal/${category}`);
                            foundInCategory = "TicketsTotal";
                            break;
                        }
                    }

                    // Si non trouvé dans TicketsTotal, chercher dans TicketsTransit
                    if (!foundTicket) {
                        for (const transitId in transitTickets) {
                            if (transitTickets[transitId].user === ticket.username) {
                                foundTicket = {
                                    category: transitTickets[transitId].category,
                                    user: transitTickets[transitId].user,
                                    password: transitTickets[transitId].password,
                                    price: transitTickets[transitId].price
                                };
                                foundTicketRef = ref(db, `TicketsTransit/${transitId}`);
                                foundInCategory = "TicketsTransit";
                                break;
                            }
                        }
                    }

                    if (foundTicket) {
                        pageLoaderMessage.textContent = `Vente du ticket ${ticket.username}...`;
                        await sellTicketAutomatically(foundTicket, foundTicketRef, foundInCategory);
                    }
                }
            } catch (error) {
                console.error("Erreur lors du traitement du ticket :", error);
                showNotification("Erreur", `Erreur lors du traitement du ticket ${ticket.username}.`);
            }
        }

        async function sellTicketAutomatically(ticket, ticketRef, foundInCategory) {
            try {
                const automaticVendorId = "Vendeur automatique";

                // Enregistrement de la vente dans VendorsHistory
                const vendorHistoryRef = ref(db, `VendorsHistory/${automaticVendorId}`);
                await push(vendorHistoryRef, {
                    category: ticket.category,
                    user: ticket.user,
                    password: ticket.password,
                    price: ticket.price,
                    soldAt: Date.now()
                });

                // Enregistrement de la vente dans TicketsVendus
                const ticketsVendusRef = ref(db, 'TicketsVendus');
                await push(ticketsVendusRef, {
                    category: ticket.category,
                    user: ticket.user,
                    password: ticket.password,
                    price: ticket.price,
                    soldAt: Date.now(),
                    vendorId: automaticVendorId
                });

                // Suppression du ticket de la source (TicketsTotal ou TicketsTransit)
                if(foundInCategory === "TicketsTotal"){
                    await set(ticketRef, ticket.updatedData);
                } else {
                    await remove(ticketRef);
                }

                console.log(`Ticket ${ticket.user} vendu automatiquement.`);
            } catch (error) {
                console.error("Erreur lors de la vente automatique du ticket :", error);
                showNotification("Erreur", "Erreur lors de la vente automatique du ticket.");
            }
        }
    </script>
</body>
</html>