<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme Gemini Améliorée</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdn.fedapay.com/checkout.js?v=1.1.7"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.29.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PizZip/3.0.6/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #50c878;
            --background-color: #f5f7fa;
            --text-color: #333333;
            --input-background: #ffffff;
            --button-color: #4a90e2;
            --hover-color: #3a7bc8;
            --sidebar-color: #2c3e50;
            --sidebar-text: #ecf0f1;
            --input-area-color: #e8f0fe;
            --user-message-color: #e1f5fe;
            --ai-message-color: #e8f5e9;
        }

        [data-theme="dark"] {
            --primary-color: #6c5ce7;
            --secondary-color: #00b894;
            --background-color: #2d3436;
            --text-color: #ecf0f1;
            --input-background: #34495e;
            --button-color: #6c5ce7;
            --hover-color: #5b4cc4;
            --sidebar-color: #2c3e50;
            --sidebar-text: #ecf0f1;
            --input-area-color: #3d4852;
            --user-message-color: #3949ab;
            --ai-message-color: #1b5e20;
        }

        body, html {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background-color: var(--primary-color);
            color: white;
            height: 30px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            margin-right: 10px;
        }

        .logo {
            font-size: 1.2em;
            font-weight: bold;
        }

        .auth-buttons button, .theme-toggle {
            margin-left: 5px;
            background-color: var(--button-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.8em;
        }

        .auth-buttons button:hover, .theme-toggle:hover {
            background-color: var(--hover-color);
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            margin-top: 30px;
        }

        .sidebar {
            width: 260px;
            background-color: var(--sidebar-color);
            color: var(--sidebar-text);
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
            position: fixed;
            top: 30px;
            bottom: 0;
            left: 0;
            z-index: 999;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }

        .message-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .input-container {
            display: flex;
            padding: 15px;
            align-items: center;
            background-color: var(--input-area-color);
            border-radius: 10px;
            margin-top: 20px;
            position: sticky;
            bottom: 0;
        }

        #userInput {
            flex-grow: 1;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            font-size: 1em;
            padding: 10px;
            outline: none;
            resize: vertical;
            min-height: 20px;
            max-height: 150px;
        }

        input, select, button, textarea {
            background-color: var(--input-background);
            border: 1px solid var(--button-color);
            color: var(--text-color);
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
        }

        button {
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--hover-color);
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }

        .user-message {
            background-color: var(--user-message-color);
            color: var(--text-color);
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }

        .ai-message {
            background-color: var(--ai-message-color);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }

        #modelSelect, #subscriptionSelect, #creditSelect {
            width: 100%;
            margin-bottom: 10px;
            background-color: var(--input-background);
            color: var(--text-color);
            border: 1px solid var(--button-color);
            padding: 10px;
            border-radius: 5px;
        }

        .hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 40px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.success {
            background-color: var(--secondary-color);
        }

        .notification.error {
            background-color: #e74c3c;
        }

        .file-input {
            display: none;
        }

        .file-label {
            cursor: pointer;
            margin-left: 10px;
            color: var(--button-color);
        }

        .message-actions {
            margin-top: 5px;
        }

        .message-actions button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.9em;
        }

        .pinned-file {
            background-color: var(--input-background);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #conversationHistory {
            margin-top: 20px;
        }

        #conversationHistory h3 {
            margin-bottom: 10px;
        }

        .conversation-item {
            padding: 10px;
            margin-bottom: 5px;
            background-color: var(--input-background);
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .conversation-item:hover {
            background-color: var(--hover-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--background-color);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--button-color);
            width: 300px;
            border-radius: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: var(--text-color);
            text-decoration: none;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.visible {
                transform: translateX(0);
            }

            .chat-container {
                margin-left: 0;
            }

            .chat-container.sidebar-visible {
                margin-left: 0;
            }

            .header {
                padding: 5px;
            }

            .logo {
                font-size: 1em;
            }

            .auth-buttons button, .theme-toggle {
                padding: 3px 6px;
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <button class="toggle-sidebar" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">Eduque moi</div>
        </div>
        <div class="auth-buttons">
            <button id="loginBtn" onclick="showLoginModal()">Se connecter</button>
            <button id="registerBtn" onclick="showRegisterModal()">S'inscrire</button>
            <button id="logoutBtn" onclick="logout()" class="hidden">Se déconnecter</button>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h3>Modèles</h3>
            <select id="modelSelect" onchange="checkModelAccess()">
                <optgroup label="Modèle gratuit">
                    <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                </optgroup>
                <optgroup label="Modèles avancés">
                    <option value="gemini-pro">Gemini Pro</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro Latest</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                </optgroup>
            </select>

            <h3>Forfaits illimités</h3>
            <select id="subscriptionSelect">
                <option value="">Sélectionnez un forfait</option>
                <option value="24h">24 heures</option>
                <option value="3d">3 jours</option>
                <option value="7d">7 jours</option>
                <option value="30d">30 jours</option>
                <option value="3m">3 mois</option>
            </select>
            <button onclick="buySubscription()">Acheter le forfait</button>

            <h3>Acheter des crédits</h3>
            <select id="creditSelect">
                <option value="">Sélectionnez un pack</option>
                <option value="100">100 crédits</option>
                <option value="500">500 crédits</option>
                <option value="1000">1000 crédits</option>
            </select>
            <button onclick="buyCredits()">Acheter des crédits</button>

            <div id="userInfo" class="hidden">
                <h3>Informations utilisateur</h3>
                <p>Nom: <span id="username"></span></p>
                <p>Crédits gratuits: <span id="freeCredits"></span></p>
                <p>Crédits payants: <span id="paidCredits"></span></p>
                <p>Forfait: <span id="subscription"></span></p>
            </div>

            <div id="conversationHistory">
                <h3>Historique des conversations</h3>
                <!-- Les conversations seront ajoutées ici dynamiquement -->
            </div>
        </div>

        <div class="chat-container">
            <div id="messageContainer" class="message-container"></div>
            <div id="pinnedFile" class="pinned-file hidden"></div>
            <div class="input-container">
                <textarea id="userInput" placeholder="Tapez votre message ici..." rows="1"></textarea>
                <label for="fileInput" class="file-label">
                    <i class="fas fa-paperclip"></i>
                </label>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt" onchange="handleFileUpload(event)">
                <button onclick="sendMessage()">Envoyer</button>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2>Connexion</h2>
            <input type="text" id="loginUsername" placeholder="Nom d'utilisateur">
            <input type="password" id="loginPassword" placeholder="Mot de passe">
            <button onclick="login()">Se connecter</button>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2>Inscription</h2>
            <input type="text" id="registerUsername" placeholder="Nom d'utilisateur">
            <input type="password" id="registerPassword" placeholder="Mot de passe">
            <button onclick="register()">S'inscrire</button>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyB3umTE3n2d5gwKzOmJz4ss1pFZMR8_vOE';
        const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        let currentUser = null;
        let pinnedFile = null;
        let currentConversation = [];
        let conversations = {};
        const FREE_CREDITS_PER_DAY = 10;
        const FREE_MODEL_MAX_WORDS = 50;
        const FREE_MODEL_MAX_RESPONSE = 100;

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCvizcYorGDPN3GXqma0opp7wAiMkaCt64",
  authDomain: "gemini-bb56e.firebaseapp.com",
  databaseURL: "https://gemini-bb56e-default-rtdb.firebaseio.com",
  projectId: "gemini-bb56e",
  storageBucket: "gemini-bb56e.appspot.com",
  messagingSenderId: "277143630015",
  appId: "1:277143630015:web:78736f2cf52d29495d160a",
  measurementId: "G-CSN292219J"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function showRegisterModal() {
            document.getElementById('registerModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function updateUIForLoggedInUser() {
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('username').textContent = currentUser.username;
            document.getElementById('freeCredits').textContent = currentUser.freeCredits;
            document.getElementById('paidCredits').textContent = currentUser.paidCredits;
            document.getElementById('subscription').textContent = currentUser.subscription || 'Aucun';
            loadConversationHistory();
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('conversationHistory').innerHTML = '<h3>Historique des conversations</h3>';
        }

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!username || !password) {
                showNotification('Veuillez remplir tous les champs.', 'error');
                return;
            }

            try {
                const userRef = db.ref('users/' + username);
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    showNotification('Ce nom d\'utilisateur existe déjà.', 'error');
                    return;
                }
                
                const now = new Date();
                await userRef.set({
                    password: password,
                    freeCredits: FREE_CREDITS_PER_DAY,
                    paidCredits: 0,
                    subscription: null,
                    subscriptionEndDate: null,
                    lastFreeCreditsReset: now.toISOString()
                });
                
                currentUser = { 
                    username, 
                    freeCredits: FREE_CREDITS_PER_DAY, 
                    paidCredits: 0, 
                    subscription: null, 
                    subscriptionEndDate: null,
                    lastFreeCreditsReset: now.toISOString()
                };
                updateUIForLoggedInUser();
                showNotification('Inscription réussie !', 'success');
                closeModal('registerModal');
            } catch (error) {
                console.error('Erreur lors de l\'inscription:', error);
                showNotification('Erreur lors de l\'inscription. Veuillez réessayer.', 'error');
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showNotification('Veuillez remplir tous les champs.', 'error');
                return;
            }

            try {
                const userRef = db.ref('users/' + username);
                const snapshot = await userRef.once('value');
                if (snapshot.exists() && snapshot.val().password === password) {
                    const userData = snapshot.val();
                    currentUser = { 
                        username, 
                        freeCredits: userData.freeCredits,
                        paidCredits: userData.paidCredits,
                        subscription: userData.subscription,
                        subscriptionEndDate: userData.subscriptionEndDate,
                        lastFreeCreditsReset: userData.lastFreeCreditsReset
                    };
                    await resetFreeCreditsIfNeeded();
                    updateUIForLoggedInUser();
                    showNotification('Connexion réussie !', 'success');
                    closeModal('loginModal');
                } else {
                    showNotification('Nom d\'utilisateur ou mot de passe incorrect.', 'error');
                }
            } catch (error) {
                console.error('Erreur lors de la connexion:', error);
                showNotification('Erreur lors de la connexion. Veuillez réessayer.', 'error');
            }
        }

        async function logout() {
            if (currentUser) {
                await syncUserData(); // Synchroniser les données avant la déconnexion
            }
            currentUser = null;
            updateUIForLoggedOutUser();
            showNotification('Déconnexion réussie.', 'success');
        }

        async function resetFreeCreditsIfNeeded() {
            const now = new Date();
            const lastReset = new Date(currentUser.lastFreeCreditsReset);
            if (now.getTime() - lastReset.getTime() >= 24 * 60 * 60 * 1000) {
                currentUser.freeCredits = FREE_CREDITS_PER_DAY;
                currentUser.lastFreeCreditsReset = now.toISOString();
                await syncUserData();
                document.getElementById('freeCredits').textContent = currentUser.freeCredits;
            }
        }

        function checkModelAccess() {
            const selectedModel = document.getElementById('modelSelect').value;
            if (selectedModel !== 'gemini-1.0-pro' && !hasValidSubscription() && currentUser.paidCredits <= 0) {
                showPaymentNotification('Ce modèle nécessite un abonnement ou des crédits payants.');
                document.getElementById('modelSelect').value = 'gemini-1.0-pro';
            }
        }

        async function sendMessage() {
            if (!currentUser) {
                showNotification('Veuillez vous connecter pour envoyer des messages.', 'error');
                return;
            }

            const userInput = document.getElementById('userInput').value;
            const model = document.getElementById('modelSelect').value;

            if (!userInput && !pinnedFile) {
                showNotification('Veuillez entrer un message ou joindre un fichier.', 'error');
                return;
            }

            let fullMessage = userInput;
            if (pinnedFile) {
                fullMessage = `[Contenu du fichier joint: ${pinnedFile.content}]\n\n${userInput}`;
            }

            // Vérification des limites pour le modèle gratuit
            if (model === 'gemini-1.0-pro') {
                const wordCount = fullMessage.split(/\s+/).length;
                if (wordCount > FREE_MODEL_MAX_WORDS) {
                    showPaymentNotification(`Le message dépasse la limite de ${FREE_MODEL_MAX_WORDS} mots pour le modèle gratuit.`);
                    return;
                }
            }

            addMessageToChat('user', fullMessage);
            document.getElementById('userInput').value = '';

            if (!hasEnoughCredits(model)) {
                showPaymentNotification('Vous n\'avez plus de crédits. Veuillez acheter des crédits ou un forfait pour continuer.');
                return;
            }

            try {
                const response = await axios.post(`${API_BASE_URL}${model}:generateContent?key=${API_KEY}`, {
                    contents: [{ parts: [{ text: currentConversation.map(msg => msg.content).join('\n') + '\n' + fullMessage }] }]
                });

                let aiResponse = response.data.candidates[0].content.parts[0].text;

                // Tronquer la réponse si nécessaire pour le modèle gratuit
                if (model === 'gemini-1.0-pro') {
                    const words = aiResponse.split(/\s+/);
                    if (words.length > FREE_MODEL_MAX_RESPONSE) {
                        aiResponse = words.slice(0, FREE_MODEL_MAX_RESPONSE).join(' ') + '...';
                        showNotification(`La réponse a été tronquée à ${FREE_MODEL_MAX_RESPONSE} mots.`, 'info');
                    }
                }

                addMessageToChat('ai', aiResponse);

                await updateCredits(model);
                removePinnedFile();
                saveConversation();
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de la génération de la réponse.', 'error');
            }
        }

        function hasEnoughCredits(model) {
            if (hasValidSubscription()) return true;
            if (model === 'gemini-1.0-pro') return currentUser.freeCredits > 0;
            return currentUser.paidCredits > 0;
        }

        async function updateCredits(model) {
    if (hasValidSubscription()) return;
    if (model === 'gemini-1.0-pro') {
        currentUser.freeCredits--;
        document.getElementById('freeCredits').textContent = currentUser.freeCredits;
    } else {
        currentUser.paidCredits--;
        document.getElementById('paidCredits').textContent = currentUser.paidCredits;
    }
    await syncUserData();
}

        function addMessageToChat(sender, message) {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageElement.textContent = message;

            if (sender === 'ai') {
                const actionsElement = document.createElement('div');
                actionsElement.classList.add('message-actions');
                actionsElement.innerHTML = `
                    <button onclick="copyResponse(this)"><i class="fas fa-copy"></i></button>
                    <button onclick="exportResponse(this, 'word')"><i class="fas fa-file-word"></i></button>
                    <button onclick="exportResponse(this, 'pdf')"><i class="fas fa-file-pdf"></i></button>
                    <button onclick="shareResponse(this)"><i class="fas fa-share-alt"></i></button>
                `;
                messageElement.appendChild(actionsElement);
            }

            messageContainer.appendChild(messageElement);
            messageContainer.scrollTop = messageContainer.scrollHeight;

            currentConversation.push({ sender, content: message });
        }

        function copyResponse(button) {
            const responseText = button.closest('.message').textContent;
            navigator.clipboard.writeText(responseText).then(() => {
                showNotification('Réponse copiée dans le presse-papiers', 'success');
            });
        }

        async function exportResponse(button, format) {
            const responseText = button.closest('.message').textContent;
            if (format === 'word') {
                const blob = await generateWordDoc(responseText);
                saveAs(blob, "response.docx");
            } else if (format === 'pdf') {
                const blob = await generatePDF(responseText);
                saveAs(blob, "response.pdf");
            }
            showNotification(`Export en ${format.toUpperCase()} réussi`, 'success');
        }

        async function generateWordDoc(text) {
            const content = `
                <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                    <w:body>
                        <w:p>
                            <w:pPr>
                                <w:pStyle w:val ="Heading1"/>
                            </w:pPr>
                            <w:r>
                                <w:t>Réponse d'Eduque moi</w:t>
                            </w:r>
                        </w:p>
                        <w:p>
                            <w:r>
                                <w:t>${text}</w:t>
                            </w:r>
                        </w:p>
                    </w:body>
                </w:document>
            `;
            const zip = new PizZip();
            zip.file("word/document.xml", content);
            const blob = await zip.generateAsync({type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
            return blob;
        }

        function generatePDF(text) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Ajout du titre
            doc.setFontSize(18);
            doc.text("Réponse d'Eduque moi", 20, 20);
            
            // Ajout du contenu
            doc.setFontSize(12);
            const splitText = doc.splitTextToSize(text, 170);
            doc.text(splitText, 20, 30);
            
            return doc.output('blob');
        }

        function shareResponse(button) {
            const responseText = button.closest('.message').textContent;
            if (navigator.share) {
                navigator.share({
                    title: 'Réponse de Eduque moi',
                    text: responseText
                }).then(() => {
                    showNotification('Partage réussi', 'success');
                }).catch((error) => {
                    console.error('Erreur lors du partage:', error);
                    showNotification('Erreur lors du partage', 'error');
                });
            } else {
                showNotification('Le partage n\'est pas pris en charge sur votre appareil', 'error');
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pinnedFile = {
                        name: file.name,
                        content: e.target.result
                    };
                    const pinnedFileElement = document.getElementById('pinnedFile');
                    pinnedFileElement.innerHTML = `
                        <span>${file.name}</span>
                        <button onclick="removePinnedFile()"><i class="fas fa-times"></i></button>
                    `;
                    pinnedFileElement.classList.remove('hidden');
                };
                reader.readAsText(file);
            }
        }

        function removePinnedFile() {
            pinnedFile = null;
            const pinnedFileElement = document.getElementById('pinnedFile');
            pinnedFileElement.innerHTML = '';
            pinnedFileElement.classList.add('hidden');
        }

        function hasValidSubscription() {
            if (!currentUser.subscription || !currentUser.subscriptionEndDate) return false;
            return new Date() < new Date(currentUser.subscriptionEndDate);
        }

        function buySubscription() {
            const subscriptionType = document.getElementById('subscriptionSelect').value;
            if (!subscriptionType) {
                showNotification('Veuillez sélectionner un forfait.', 'error');
                return;
            }

            const subscriptionPrices = {
                '24h': 500, '3d': 1000, '7d': 2000, '30d': 5000, '3m': 12000
            };

            const price = subscriptionPrices[subscriptionType];

            var fedaPayInstance = FedaPay.init({
                public_key: 'pk_live_TfSz212W0xSMKK7oPEogkFmp',
                transaction: {
                    amount: price,
                    description: `Achat d'un forfait ${subscriptionType} pour Eduque moi`
                },
                customer: {
                    email: 'client@example.com'
                },
                onComplete: function(response) {
                    if (response.reason === FedaPay.CHECKOUT_COMPLETED) {
                        activateSubscription(subscriptionType);
                        showNotification(`Forfait ${subscriptionType} activé avec succès !`, 'success');
                    } else {
                        showNotification('Le paiement a été annulé ou a échoué.', 'error');
                    }
                }
            });
            fedaPayInstance.open();
        }

        async function activateSubscription(subscriptionType) {
            const durations = { '24h': 1, '3d': 3, '7d': 7, '30d': 30, '3m': 90 };
            const days = durations[subscriptionType];
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + days);

            currentUser.subscription = subscriptionType;
            currentUser.subscriptionEndDate = endDate.toISOString();

            await syncUserData();

            document.getElementById('subscription').textContent = subscriptionType;
        }

        function buyCredits() {
            const creditAmount = document.getElementById('creditSelect').value;
            if (!creditAmount) {
                showNotification('Veuillez sélectionner un pack de crédits.', 'error');
                return;
            }

            const creditPrices = {
                '100': 1000, '500': 4500, '1000': 8000
            };

            const price = creditPrices[creditAmount];

            var fedaPayInstance = FedaPay.init({
                public_key: 'pk_live_TfSz212W0xSMKK7oPEogkFmp',
                transaction: {
                    amount: price,
                    description: `Achat de ${creditAmount} crédits pour Eduque moi`
                },
                customer: {
                    email: 'client@example.com'
                },
                onComplete: function(response) {
                    if (response.reason === FedaPay.CHECKOUT_COMPLETED) {
                        addCreditsToUser(parseInt(creditAmount));
                        showNotification(`${creditAmount} crédits ont été ajoutés à votre compte.`, 'success');
                    } else {
                        showNotification('Le paiement a été annulé ou a échoué.', 'error');
                    }
                }
            });
            fedaPayInstance.open();
        }

        async function addCreditsToUser(amount) {
            currentUser.paidCredits += amount;
            await syncUserData();
            document.getElementById('paidCredits').textContent = currentUser.paidCredits;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }, 100);
        }

        function showPaymentNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.innerHTML = `
                ${message}<br>
                <button onclick="buySubscription()">Acheter un abonnement</button>
                <button onclick="buyCredits()">Acheter des crédits</button>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 10000); // Afficher pendant 10 secondes
            }, 100);
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeToggle = document.querySelector('.theme-toggle i');
            themeToggle.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const chatContainer = document.querySelector('.chat-container');
            sidebar.classList.toggle('visible');
            chatContainer.classList.toggle('sidebar-visible');
        }

        function saveConversation() {
            if (!currentUser) return;
            const conversationId = Date.now().toString();
            conversations[conversationId] = currentConversation;
            localStorage.setItem(`conversations_${currentUser.username}`, JSON.stringify(conversations));
            updateConversationHistory();
        }

        function loadConversationHistory() {
            if (!currentUser) return;
            const savedConversations = localStorage.getItem(`conversations_${currentUser.username}`);
            if (savedConversations) {
                conversations = JSON.parse(savedConversations);
                updateConversationHistory();
            }
        }

        function updateConversationHistory() {
            const historyContainer = document.getElementById('conversationHistory');
            historyContainer.innerHTML = '<h3>Historique des conversations</h3>';
            Object.keys(conversations).forEach(id => {
                const conversation = conversations[id];
                const element = document.createElement('div');
                element.className = 'conversation-item';
                element.textContent = `Conversation du ${new Date(parseInt(id)).toLocaleString()}`;
                element.onclick = () => loadConversation(id);
                historyContainer.appendChild(element);
            });
        }

        function loadConversation(id) {
            currentConversation = conversations[id];
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = '';
            currentConversation.forEach(message => {
                addMessageToChat(message.sender, message.content);
            });
        }

        async function syncUserData() {
            if (!currentUser) return;
            const userRef = db.ref('users/' + currentUser.username);
            await userRef.update({
                freeCredits: currentUser.freeCredits,
                paidCredits: currentUser.paidCredits,
                subscription: currentUser.subscription,
                subscriptionEndDate: currentUser.subscriptionEndDate,
                lastFreeCreditsReset: currentUser.lastFreeCreditsReset
            });
        }

        // Fonction pour ajuster la hauteur du textarea
        function adjustTextareaHeight() {
            const textarea = document.getElementById('userInput');
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Initialisation au chargement de la page
        window.onload = function() {
            const savedUser = getUserFromLocalStorage();
            if (savedUser) {
                currentUser = savedUser;
                updateUIForLoggedInUser();
                resetFreeCreditsIfNeeded();
            } else {
                updateUIForLoggedOutUser();
            }

            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            // Ajustement du champ de saisie pour qu'il prenne toute la largeur disponible
            const inputContainer = document.querySelector('.input-container');
            const userInput = document.getElementById('userInput');
            const fileLabel = document.querySelector('.file-label');
            const sendButton = inputContainer.querySelector('button');

            function adjustInputWidth() {
                const containerWidth = inputContainer.offsetWidth;
                const fileLabelWidth = fileLabel.offsetWidth;
                const sendButtonWidth = sendButton.offsetWidth;
                const padding = 20; // Ajustez selon vos besoins
                userInput.style.width = `${containerWidth - fileLabelWidth - sendButtonWidth - padding}px`;
            }

            // Appel initial et ajout d'un écouteur d'événement pour le redimensionnement de la fenêtre
            adjustInputWidth();
            window.addEventListener('resize', adjustInputWidth);

            // Ajout d'un écouteur d'événement pour ajuster la hauteur du textarea
            userInput.addEventListener('input', adjustTextareaHeight);

            // Ajout d'un écouteur d'événement pour vérifier l'accès au modèle
            document.getElementById('modelSelect').addEventListener('change', checkModelAccess);

            // Gestion de l'affichage de la barre latérale sur les appareils mobiles
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('visible');
                document.querySelector('.chat-container').classList.remove('sidebar-visible');
            }

            // Synchronisation en temps réel avec Firebase
            if (currentUser) {
                const userRef = db.ref('users/' + currentUser.username);
                userRef.on('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        currentUser = {
                            ...currentUser,
                            freeCredits: userData.freeCredits,
                            paidCredits: userData.paidCredits,
                            subscription: userData.subscription,
                            subscriptionEndDate: userData.subscriptionEndDate,
                            lastFreeCreditsReset: userData.lastFreeCreditsReset
                        };
                        updateUIForLoggedInUser();
                    }
                });
            }
        };

        // Ajout d'un écouteur d'événement pour le chargement des ressources
        window.addEventListener('load', function() {
            document.body.classList.add('loaded');
        });
    </script>
</body>
</html>
