<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme Gemini Améliorée</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdn.fedapay.com/checkout.js?v=1.1.7"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --background-color: #ffffff;
            --text-color: #333333;
            --input-background: #f0f0f0;
            --button-color: #4a4b55;
            --hover-color: #e0e0e0;
        }

        [data-theme="dark"] {
            --background-color: #202123;
            --text-color: #ffffff;
            --input-background: #40414f;
            --button-color: #4a4b55;
            --hover-color: #2e2f34;
        }

        body, html {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--input-background);
        }

        .logo {
            font-size: 1.5em;
            font-weight: bold;
        }

        .auth-buttons button, .theme-toggle {
            margin-left: 10px;
            background-color: var(--button-color);
            color: var(--text-color);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background-color: var(--input-background);
            padding: 20px;
            overflow-y: auto;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .message-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .input-container {
            display: flex;
            padding: 10px;
            align-items: center;
        }

        input, select, button, textarea {
            background-color: var(--input-background);
            border: 1px solid var(--button-color);
            color: var(--text-color);
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
        }

        button {
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--hover-color);
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            max-width: 80%;
        }

        .user-message {
            background-color: var(--input-background);
            align-self: flex-end;
        }

        .ai-message {
            background-color: var(--button-color);
            align-self: flex-start;
        }

        #modelSelect, #subscriptionSelect, #creditSelect {
            width: 100%;
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.success {
            background-color: #4CAF50;
        }

        .notification.error {
            background-color: #f44336;
        }

        #gpt4oFrame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .file-input {
            display: none;
        }

        .file-label {
            cursor: pointer;
            margin-left: 10px;
        }

        .message-actions {
            margin-top: 5px;
        }

        .message-actions button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Gemini AI</div>
        <div class="auth-buttons">
            <button id="loginBtn" onclick="showLoginForm()">Se connecter</button>
            <button id="registerBtn" onclick="showRegisterForm()">S'inscrire</button>
            <button id="logoutBtn" onclick="logout()" class="hidden">Se déconnecter</button>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h3>Modèles</h3>
            <select id="modelSelect" onchange="handleModelChange()">
                <optgroup label="Modèle gratuit">
                    <option value="gpt4o-mini">GPT4o mini</option>
                </optgroup>
                <optgroup label="Modèles avancés">
                    <option value="gemini-pro">Gemini Pro</option>
                    <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro Latest</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                </optgroup>
            </select>

            <h3>Forfaits illimités</h3>
            <select id="subscriptionSelect">
                <option value="">Sélectionnez un forfait</option>
                <option value="24h">24 heures</option>
                <option value="3d">3 jours</option>
                <option value="7d">7 jours</option>
                <option value="30d">30 jours</option>
                <option value="3m">3 mois</option>
            </select>
            <button onclick="buySubscription()">Acheter le forfait</button>

            <h3>Acheter des crédits</h3>
            <select id="creditSelect">
                <option value="">Sélectionnez un pack</option>
                <option value="100">100 crédits</option>
                <option value="500">500 crédits</option>
                <option value="1000">1000 crédits</option>
            </select>
            <button onclick="buyCredits()">Acheter des crédits</button>

            <div id="userInfo" class="hidden">
                <h3>Informations utilisateur</h3>
                <p>Nom: <span id="username"></span></p>
                <p>Crédits: <span id="credits"></span></p>
                <p>Forfait: <span id="subscription"></span></p>
            </div>
        </div>

        <div class="chat-container">
            <div id="messageContainer" class="message-container"></div>
            <iframe id="gpt4oFrame" class="hidden" src="https://chatgpt.com/"></iframe>
            <div class="input-container">
                <textarea id="userInput" placeholder="Tapez votre message ici..."></textarea>
                <label for="fileInput" class="file-label">
                    <i class="fas fa-paperclip"></i>
                </label>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" onchange="handleFileUpload(event)">
                <button onclick="sendMessage()">Envoyer</button>
            </div>
        </div>
    </div>

    <div id="loginForm" class="hidden">
        <input type="text" id="loginUsername" placeholder="Nom d'utilisateur">
        <input type="password" id="loginPassword" placeholder="Mot de passe">
        <button onclick="login()">Se connecter</button>
    </div>

    <div id="registerForm" class="hidden">
        <input type="text" id="registerUsername" placeholder="Nom d'utilisateur">
        <input type="password" id="registerPassword" placeholder="Mot de passe">
        <button onclick="register()">S'inscrire</button>
    </div>

    <script>
        const API_KEY = 'AIzaSyB3umTE3n2d5gwKzOmJz4ss1pFZMR8_vOE';
        const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        let currentUser = null;

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB6AUBnK_7Vy2ABWI2JMo3ebG_Sljr8XlY",
            authDomain: "cyber-campus-2706f.firebaseapp.com",
            databaseURL: "https://cyber-campus-2706f-default-rtdb.firebaseio.com",
            projectId: "cyber-campus-2706f",
            storageBucket: "cyber-campus-2706f.appspot.com",
            messagingSenderId: "719410601264",
            appId: "1:719410601264:web:44fd2e3757721866303cf5",
            measurementId: "G-CEEFJP5LYZ"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function saveUserToLocalStorage(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
        }

        function getUserFromLocalStorage() {
            const userStr = localStorage.getItem('currentUser');
            return userStr ? JSON.parse(userStr) : null;
        }

        function removeUserFromLocalStorage() {
            localStorage.removeItem('currentUser');
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function updateUIForLoggedInUser() {
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('username').textContent = currentUser.username;
            document.getElementById('credits').textContent = currentUser.credits;
            document.getElementById('subscription').textContent = currentUser.subscription || 'Aucun';
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!username || !password) {
                showNotification('Veuillez remplir tous les champs.', 'error');
                return;
            }

            try {
                const userRef = db.ref('users/' + username);
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    showNotification('Ce nom d\'utilisateur existe déjà.', 'error');
                    return;
                }
                
                await userRef.set({
                    password: password,
                    credits: 10,
                    subscription: null,
                    subscriptionEndDate: null
                });
                
                currentUser = { username, credits: 10, subscription: null, subscriptionEndDate: null };
                saveUserToLocalStorage(currentUser);
                updateUIForLoggedInUser();
                showNotification('Inscription réussie !', 'success');
            } catch (error) {
                console.error('Erreur lors de l\'inscription:', error);
                showNotification('Erreur lors de l\'inscription. Veuillez réessayer.', 'error');
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showNotification('Veuillez remplir tous les champs.', 'error');
                return;
            }

            try {
                const userRef = db.ref('users/' + username);
                const snapshot = await userRef.once('value');
                if (snapshot.exists() && snapshot.val().password === password) {
                    currentUser = { 
                        username, 
                        credits: snapshot.val().credits,
                        subscription: snapshot.val().subscription,
                        subscriptionEndDate: snapshot.val().subscriptionEndDate
                    };
                    saveUserToLocalStorage(currentUser);
                    updateUIForLoggedInUser();
                    showNotification('Connexion réussie !', 'success');
                } else {
                    showNotification('Nom d\'utilisateur ou mot de passe incorrect.', 'error');
                }
            } catch (error) {
                console.error('Erreur lors de la connexion:', error);
                showNotification('Erreur lors de la connexion. Veuillez réessayer.', 'error');
            }
        }

        function logout() {
            currentUser = null;
            removeUserFromLocalStorage();
            updateUIForLoggedOutUser();
            showNotification('Déconnexion réussie.', 'success');
        }

        function handleModelChange() {
            const model = document.getElementById('modelSelect').value;
            const gpt4oFrame = document.getElementById('gpt4oFrame');
            const messageContainer = document.getElementById('messageContainer');
            const inputContainer = document.querySelector('.input-container');

            if (model === 'gpt4o-mini') {
                gpt4oFrame.classList.remove('hidden');
                messageContainer.classList.add('hidden');
                inputContainer.classList.add('hidden');
            } else {
                gpt4oFrame.classList.add('hidden');
                messageContainer.classList.remove('hidden');
                inputContainer.classList.remove('hidden');
            }
        }

        async function sendMessage() {
            if (!currentUser) {
                showNotification('Veuillez vous connecter pour envoyer des messages.', 'error');
                return;
            }

            const userInput = document.getElementById('userInput').value;
            const model = document.getElementById('modelSelect').value;

            if (!userInput) return;

            addMessageToChat('user', userInput);
            document.getElementById('userInput').value = '';

            if (model !== 'gpt4o-mini' && !hasValidSubscription() && currentUser.credits <= 0) {
                showNotification('Vous n\'avez plus de crédits. Veuillez acheter des crédits ou un forfait pour continuer.', 'error');
                return;
            }

            try {
                const response = await axios.post(`${API_BASE_URL}${model}:generateContent?key=${API_KEY}`, {
                    contents: [{ parts: [{ text: userInput }] }]
                });

                const aiResponse = response.data.candidates[0].content.parts[0].text;
                addMessageToChat('ai', aiResponse);

                if (model !== 'gpt4o-mini' && !hasValidSubscription()) {
                    currentUser.credits--;
                    updateUserCredits();
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de la génération de la réponse.', 'error');
            }
        }

        function addMessageToChat(sender, message) {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageElement.textContent = message;

            if (sender === 'ai' && document.getElementById('modelSelect').value !== 'gpt4o-mini') {
                const actionsElement = document.createElement('div');
                actionsElement.classList.add('message-actions');
                actionsElement.innerHTML = `
                    <button onclick="copyResponse(this)"><i class="fas fa-copy"></i></button>
                    <button onclick="exportResponse(this, 'word')"><i class="fas fa-file-word"></i></button>
                    <button onclick="exportResponse(this, 'pdf')"><i class="fas fa-file-pdf"></i></button>
                    <button onclick="shareResponse(this)"><i class="fas fa-share-alt"></i></button>
                `;
                messageElement.appendChild(actionsElement);
            }

            messageContainer.appendChild(messageElement);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function copyResponse(button) {
            const responseText = button.closest('.message').textContent;
            navigator.clipboard.writeText(responseText).then(() => {
                showNotification('Réponse copiée dans le presse-papiers', 'success');
            });
        }

        function exportResponse(button, format) {
            const responseText = button.closest('.message').textContent;
            // Ici, vous devriez implémenter la logique pour exporter en Word ou PDF
            // Pour cet exemple, nous allons simplement simuler l'export
            showNotification(`Export en ${format} simulé`, 'success');
        }

        function shareResponse(button) {
            const responseText = button.closest('.message').textContent;
            // Ici, vous devriez implémenter la logique de partage
            // Pour cet exemple, nous allons simplement simuler le partage
            showNotification('Partage simulé', 'success');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Ici, vous devriez implémenter la logique pour traiter le fichier
                // Pour cet exemple, nous allons simplement afficher le nom du fichier
                addMessageToChat('user', `Fichier téléchargé : ${file.name}`);
            }
        }

        function hasValidSubscription() {
            if (!currentUser.subscription || !currentUser.subscriptionEndDate) return false;
            return new Date() < new Date(currentUser.subscriptionEndDate);
        }

        async function updateUserCredits() {
            await db.ref('users/' + currentUser.username).update({
                credits: currentUser.credits
            });
            document.getElementById('credits').textContent = currentUser.credits;
        }

        function buySubscription() {
            const subscriptionType = document.getElementById('subscriptionSelect').value;
            if (!subscriptionType) {
                showNotification('Veuillez sélectionner un forfait.', 'error');
                return;
            }

            const subscriptionPrices = {
                '24h': 500, '3d': 1000, '7d': 2000, '30d': 5000, '3m': 12000
            };

            const price = subscriptionPrices[subscriptionType];

            var fedaPayInstance = FedaPay.init({
                public_key: 'pk_live_TfSz212W0xSMKK7oPEogkFmp',
                transaction: {
                    amount: price,
                    description: `Achat d'un forfait ${subscriptionType} pour Gemini AI`
                },
                customer: {
                    email: 'client@example.com'
                },
                onComplete: function(response) {
                    if (response.reason === FedaPay.CHECKOUT_COMPLETED) {
                        activateSubscription(subscriptionType);
                        showNotification(`Forfait ${subscriptionType} activé avec succès !`, 'success');
                    } else {
                        showNotification('Le paiement a été annulé ou a échoué.', 'error');
                    }
                }
            });
            fedaPayInstance.open();
        }

        async function activateSubscription(subscriptionType) {
            const durations = { '24h': 1, '3d': 3, '7d': 7, '30d': 30, '3m': 90 };
            const days = durations[subscriptionType];
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + days);

            currentUser.subscription = subscriptionType;
            currentUser.subscriptionEndDate = endDate.toISOString();

            await db.ref('users/' + currentUser.username).update({
                subscription: subscriptionType,
                subscriptionEndDate: endDate.toISOString()
            });

            document.getElementById('subscription').textContent = subscriptionType;
            saveUserToLocalStorage(currentUser);
        }

        function buyCredits() {
            const creditAmount = document.getElementById('creditSelect').value;
            if (!creditAmount) {
                showNotification('Veuillez sélectionner un pack de crédits.', 'error');
                return;
            }

            const creditPrices = {
                '100': 1000, '500': 4500, '1000': 8000
            };

            const price = creditPrices[creditAmount];

            var fedaPayInstance = FedaPay.init({
                public_key: 'pk_live_TfSz212W0xSMKK7oPEogkFmp',
                transaction: {
                    amount: price,
                    description: `Achat de ${creditAmount} crédits pour Gemini AI`
                },
                customer: {
                    email: 'client@example.com'
                },
                onComplete: function(response) {
                    if (response.reason === FedaPay.CHECKOUT_COMPLETED) {
                        addCreditsToUser(parseInt(creditAmount));
                        showNotification(`${creditAmount} crédits ont été ajoutés à votre compte.`, 'success');
                    } else {
                        showNotification('Le paiement a été annulé ou a échoué.', 'error');
                    }
                }
            });
            fedaPayInstance.open();
        }

        async function addCreditsToUser(amount) {
            currentUser.credits += amount;
            await db.ref('users/' + currentUser.username).update({
                credits: currentUser.credits
            });
            document.getElementById('credits').textContent = currentUser.credits;
            saveUserToLocalStorage(currentUser);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }, 100);
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeToggle = document.querySelector('.theme-toggle i');
            themeToggle.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Initialisation au chargement de la page
        window.onload = function() {
            const savedUser = getUserFromLocalStorage();
            if (savedUser) {
                currentUser = savedUser;
                updateUIForLoggedInUser();
            } else {
                updateUIForLoggedOutUser();
            }

            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            handleModelChange();
        };
    </script>
</body>
</html>
