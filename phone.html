<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Convertisseur GSM Bénin</title>
    <style>
        :root {
            --primary-color: #1a73e8;
            --success-color: #34a853;
            --warning-color: #fbbc04;
            --error-color: #ea4335;
            --danger-color: #dc3545;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --spacing-unit: 0.5rem;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            max-width: 100vw;
            overflow-x: hidden;
            padding-bottom: var(--safe-area-bottom);
        }

        /* App Container avec pull-to-refresh */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Header avec style iOS/Android */
        .header {
            padding: 1rem;
            background: var(--surface-color);
            border-radius: 16px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.4rem;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* Info Banner amélioré */
        .info-banner {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
            font-size: 0.95rem;
        }

        /* Tabs style natif mobile */
        .tabs {
            display: flex;
            background: var(--surface-color);
            border-radius: 12px;
            padding: 0.25rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            gap: 0.5rem;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 0.75rem 0.5rem;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            transition: all 0.3s;
            border-radius: 8px;
        }

        .tab.active {
            color: var(--primary-color);
            background: rgba(26, 115, 232, 0.1);
        }

        /* Panels avec animations tactiles */
        .panel {
            display: none;
            background: var(--surface-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel.active {
            display: block;
        }

        /* Contact List avec style natif */
        .contact-list {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0.5rem;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
            position: relative;
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 1rem;
            flex-shrink: 0;
            font-size: 1.2rem;
        }

        .contact-details {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .contact-numbers {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Actions flottantes */
        .floating-action-button {
            position: fixed;
            bottom: calc(var(--safe-area-bottom) + 1rem);
            right: 1rem;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: none;
            z-index: 100;
        }

        /* Nouveaux styles pour les fonctionnalités ajoutées */
        .contact-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .action-button {
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            background: var(--primary-color);
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            flex: 1;
        }

        .action-button.warning {
            background: var(--warning-color);
        }

        .action-button.danger {
            background: var(--danger-color);
        }

        .invalid-contacts {
            margin-top: 1rem;
            padding: 1rem;
            background: #ffebee;
            border-radius: 8px;
            border-left: 4px solid var(--danger-color);
        }

        .invalid-contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--primary-color);
        }

        /* Toast amélioré */
        .toast {
            position: fixed;
            bottom: calc(var(--safe-area-bottom) + 2rem);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 1rem 2rem;
            border-radius: 24px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 380px) {
            .contact-avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .contact-name {
                font-size: 0.95rem;
            }
            
            .contact-numbers {
                font-size: 0.85rem;
            }
            
            .action-button {
                font-size: 0.75rem;
                padding: 0.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Convertisseur GSM Bénin</h1>
            <div class="info-banner">
                Passage au format 10 chiffres : ajout du préfixe "01"<br>
                Ex: +22960374877 → +2290160374877
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('manual')">Manuel</button>
            <button class="tab" onclick="switchTab('contacts')">Contacts</button>
            <button class="tab" onclick="switchTab('import')">Importer</button>
        </div>

        <!-- Panneau manuel -->
        <div id="manual-panel" class="panel active">
            <div class="input-area">
                <textarea placeholder="Entrez vos numéros (un par ligne)&#10;Exemple:&#10;+22960374877&#10;97123456"></textarea>
                <button class="action-button" onclick="convertManualNumbers()">Convertir</button>
            </div>
        </div>

        <!-- Panneau contacts -->
        <div id="contacts-panel" class="panel">
            <button class="action-button" onclick="requestContacts()">
                Accéder aux contacts
            </button>
            
            <div class="checkbox-wrapper">
                <input type="checkbox" id="autoUpdate" checked>
                <label for="autoUpdate">Mise à jour automatique</label>
            </div>

            <div class="checkbox-wrapper">
                <input type="checkbox" id="detectInvalid" checked>
                <label for="detectInvalid">Détecter les numéros invalides</label>
            </div>

            <div id="invalid-contacts" class="invalid-contacts" style="display: none;">
                <h3>Contacts non conformes</h3>
                <div id="invalid-contacts-list"></div>
                <button class="action-button danger" onclick="deleteInvalidContacts()">
                    Supprimer les contacts sélectionnés
                </button>
            </div>

            <div class="contact-list" id="contacts-list"></div>

            <button class="floating-action-button" onclick="showActions()">
                +
            </button>
        </div>

        <!-- Panneau import -->
        <div id="import-panel" class="panel">
            <div class="file-upload-area">
                <button class="action-button" onclick="triggerFileInput()">
                    Choisir un fichier
                </button>
                <input type="file" id="file-input" accept=".csv,.vcf" style="display: none">
                <p class="text-center">Formats supportés : CSV, VCF</p>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Variables globales
        let currentContacts = [];
        let processedContacts = [];
        let invalidContacts = [];

        // Gestion des onglets
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });

            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(`${tabId}-panel`).classList.add('active');
        }

        // Toast amélioré
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('visible');
            
            setTimeout(() => {
                toast.classList.remove('visible');
            }, duration);
        }

        // Validation et conversion des numéros
        function validatePhoneNumber(number) {
            const cleanNumber = number.replace(/[\s\-\(\)]/g, '');
            
            // Vérifier si c'est un numéro du Bénin
            if (!cleanNumber.match(/^(\+229|229)?\d{8}$/)) {
                return false;
            }
            
            return true;
        }

        function convertPhoneNumber(number) {
            const cleanNumber = number.replace(/[\s\-\(\)]/g, '');

            if (cleanNumber.includes('01')) {
                return { 
                    number: cleanNumber, 
                    wasConverted: false,
                    isValid: validatePhoneNumber(cleanNumber)
                };
            }

            let convertedNumber;
            if (cleanNumber.startsWith('+229')) {
                convertedNumber = cleanNumber.slice(0, 4) + '01' + cleanNumber.slice(4);
            } else if (cleanNumber.startsWith('229')) {
                convertedNumber = '+' + cleanNumber.slice(0, 3) + '01' + cleanNumber.slice(3);
            } else if (cleanNumber.length === 8) {
                convertedNumber = '+22901' + cleanNumber;
            } else {
                return { 
                    number: cleanNumber, 
                    wasConverted: false, 
                    isValid: false 
                };
            }

            return { 
                number: convertedNumber, 
                wasConverted: true,
                isValid: validatePhoneNumber(convertedNumber)
            };
        }

        // Gestion des contacts
        async function requestContacts() {
            try {
                const contactsDiv = document.getElementById('contacts-list');
                contactsDiv.innerHTML = '<div class="loading">Chargement des contacts...</div>';

if (!('contacts' in navigator && 'ContactsManager' in window)) {
    throw new Error("L'API Contacts n'est pas disponible sur votre appareil");
}

const properties = ['name', 'tel'];
const options = { multiple: true };
const contacts = await navigator.contacts.select(properties, options);

processContacts(contacts);
} catch (error) {
showToast(`Erreur: ${error.message}`);
document.getElementById('contacts-list').innerHTML = `
    <div class="error-box">
        <p>${error.message}</p>
        <p>Cette fonction nécessite un appareil mobile compatible.</p>
    </div>
`;
}
}

// Traitement amélioré des contacts
function processContacts(contacts) {
currentContacts = contacts;
const contactsList = document.getElementById('contacts-list');
contactsList.innerHTML = '';
invalidContacts = [];

if (contacts.length === 0) {
showToast('Aucun contact sélectionné');
return;
}

processedContacts = contacts.map(contact => {
const originalNumbers = contact.tel || [];
const convertedNumbers = originalNumbers.map(num => convertPhoneNumber(num));

const needsUpdate = convertedNumbers.some(num => num.wasConverted);
const hasInvalidNumbers = convertedNumbers.some(num => !num.isValid);

if (hasInvalidNumbers && document.getElementById('detectInvalid').checked) {
    invalidContacts.push({
        name: contact.name ? contact.name[0] : 'Sans nom',
        numbers: originalNumbers,
        id: Math.random().toString(36).substring(7)
    });
}

// Créer l'élément de contact avec actions
const contactElement = document.createElement('div');
contactElement.className = 'contact-item';
contactElement.innerHTML = `
    <div class="contact-avatar">
        ${(contact.name && contact.name[0]) ? contact.name[0][0].toUpperCase() : '?'}
    </div>
    <div class="contact-details">
        <div class="contact-name">${contact.name ? contact.name[0] : 'Sans nom'}</div>
        <div class="contact-numbers">
            ${convertedNumbers.map(num => num.number).join(', ')}
        </div>
        <div class="contact-actions">
            ${needsUpdate ? `
                <button class="action-button" onclick="updateContact('${contact.name ? contact.name[0] : 'Sans nom'}')">
                    Mettre à jour
                </button>
            ` : ''}
            <button class="action-button" onclick="importToPhone('${contact.name ? contact.name[0] : 'Sans nom'}')">
                Importer
            </button>
        </div>
    </div>
    <div class="contact-status ${needsUpdate ? 'status-warning' : 'status-success'}">
        ${needsUpdate ? 'À convertir' : 'À jour'}
    </div>
`;

contactsList.appendChild(contactElement);

return {
    original: contact,
    converted: convertedNumbers,
    needsUpdate,
    hasInvalidNumbers
};
});

updateInvalidContactsList();

if (document.getElementById('autoUpdate').checked) {
updateContacts();
}
}

// Affichage des contacts invalides
function updateInvalidContactsList() {
const invalidContactsDiv = document.getElementById('invalid-contacts');
const invalidContactsList = document.getElementById('invalid-contacts-list');

if (invalidContacts.length > 0) {
invalidContactsDiv.style.display = 'block';
invalidContactsList.innerHTML = invalidContacts.map(contact => `
    <div class="invalid-contact-item">
        <div>
            <input type="checkbox" id="invalid-${contact.id}" checked>
            <label for="invalid-${contact.id}">${contact.name}: ${contact.numbers.join(', ')}</label>
        </div>
    </div>
`).join('');
} else {
invalidContactsDiv.style.display = 'none';
}
}

// Suppression des contacts non conformes
async function deleteInvalidContacts() {
const selectedContacts = invalidContacts.filter(contact => 
document.getElementById(`invalid-${contact.id}`).checked
);

if (selectedContacts.length === 0) {
showToast('Aucun contact sélectionné pour la suppression');
return;
}

if (confirm(`Voulez-vous vraiment supprimer ${selectedContacts.length} contact(s) ?`)) {
try {
    // Simulation de la suppression (à implémenter avec l'API réelle)
    showToast(`${selectedContacts.length} contact(s) supprimé(s)`);
    invalidContacts = invalidContacts.filter(contact => 
        !selectedContacts.find(selected => selected.id === contact.id)
    );
    updateInvalidContactsList();
} catch (error) {
    showToast('Erreur lors de la suppression : ' + error.message);
}
}
}

// Import d'un contact dans le téléphone
async function importToPhone(contactName) {
try {
const contact = processedContacts.find(c => 
    c.original.name && c.original.name[0] === contactName
);

if (!contact) {
    throw new Error('Contact non trouvé');
}

// Créer le contact au format vCard
let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
vcard += `FN:${contactName}\n`;
contact.converted.forEach(num => {
    if (num.isValid) {
        vcard += `TEL;TYPE=CELL:${num.number}\n`;
    }
});
vcard += 'END:VCARD';

// Créer un fichier blob et le télécharger
const blob = new Blob([vcard], { type: 'text/vcard' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `${contactName}.vcf`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);

showToast('Contact prêt à être importé');
} catch (error) {
showToast('Erreur lors de l\'import : ' + error.message);
}
}

// Mise à jour d'un contact spécifique
async function updateContact(contactName) {
try {
const contact = processedContacts.find(c => 
    c.original.name && c.original.name[0] === contactName
);

if (!contact) {
    throw new Error('Contact non trouvé');
}

// Créer le vCard pour le contact
let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
vcard += `FN:${contactName}\n`;
contact.converted.forEach(num => {
    if (num.isValid) {
        vcard += `TEL;TYPE=CELL:${num.number}\n`;
    }
});
vcard += 'END:VCARD';

// Proposer le téléchargement
downloadFile(vcard, `${contactName}_converti.vcf`, 'text/vcard');
showToast('Contact mis à jour');
} catch (error) {
showToast('Erreur lors de la mise à jour : ' + error.message);
}
}

// Utilitaire de téléchargement
function downloadFile(content, filename, type) {
const blob = new Blob([content], { type });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filename;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
if (!('contacts' in navigator)) {
document.querySelector('[onclick="switchTab(\'contacts\')"]')
    .setAttribute('disabled', 'disabled');
}

// Ajout du pull-to-refresh
let touchStart = 0;
let touchDistance = 0;

document.addEventListener('touchstart', (e) => {
touchStart = e.touches[0].pageY;
}, { passive: true });

document.addEventListener('touchmove', (e) => {
touchDistance = e.touches[0].pageY - touchStart;
if (touchDistance > 100) {
    // Déclencher le rafraîchissement
    touchDistance = 0;
    if (document.querySelector('#contacts-panel.active')) {
        requestContacts();
    }
}
}, { passive: true });
});
</script>
</body>
</html>
